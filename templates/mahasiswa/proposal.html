<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Pengajuan Proposal Mahasiswa - AYMP UNJAYA</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='lodaf/unjaya.png') }}" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/bootstrap.css') }}">

    <!-- <link rel="stylesheet" href="assets/vendors/jquery-datatables/jquery.dataTables.min.css"> -->
    <link rel="stylesheet"
        href="{{ url_for('static', filename='assets/vendors/jquery-datatables/jquery.dataTables.bootstrap5.min.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-papm6Q+..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/sweetalert2/sweetalert2.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/toastify/toastify.css') }}">
    <!-- Choices.js CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/choices.js/choices.min.css') }}">
    <style>
        table.dataTable td {
            padding: 15px 8px;
        }

        .fontawesome-icons .the-icon svg {
            font-size: 24px;
        }

        /* Bulatkan dan rapikan pagination datatable */
        .dataTables_wrapper .dataTables_paginate .pagination {
            justify-content: center;
            gap: 8px;
        }

        .dataTables_wrapper .dataTables_paginate .page-item {
            margin: 0;
        }

        .dataTables_wrapper .dataTables_paginate .page-link {
            border-radius: 50% !important;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            padding: 0 !important;
            margin: 0 !important;
            font-weight: 600;
            font-size: 1rem;
            line-height: 36px;
            border: none;
            background: transparent;
            color: #3b3f5c;
            transition: background 0.2s, color 0.2s;
            text-align: center;
        }

        .dataTables_wrapper .dataTables_paginate .page-link:focus {
            box-shadow: none;
        }

        .dataTables_wrapper .dataTables_paginate .page-item.active .page-link,
        .dataTables_wrapper .dataTables_paginate .page-link:hover {
            background: #435ebe;
            color: #fff !important;
        }

        .dataTables_wrapper .dataTables_paginate .page-link:active {
            background: #25396f;
            color: #fff !important;
        }

        .dataTables_wrapper .dataTables_paginate .page-link svg {
            vertical-align: middle;
        }

        .modal-content {
            border-radius: 20px !important;
            overflow: hidden;
        }

        .modal-header {
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px 28px 12px 28px;
        }

        .modal-footer {
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            padding: 16px 28px;
        }

        .modal-body {
            padding: 24px 28px 10px 28px;
        }

        .modal-body .row.g-3 {
            margin-bottom: 0;
        }
        
        /* Styles untuk Choices.js dropdown */
        .choices {
            margin-bottom: 0;
            width: 100%;
        }
        
        .choices__inner {
            background-color: #fff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            min-height: 38px;
            height: 38px;
            padding: 0.375rem 0.75rem;
            display: flex;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }
        
        .choices__input {
            background-color: transparent;
        }
        
        .choices__list--dropdown {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
        }
        
        .choices__list--dropdown .choices__item {
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .choices__list--dropdown .choices__item--selectable {
            cursor: pointer;
        }
        
        .choices__list--dropdown .choices__item--selectable:hover {
            background-color: #f3f4f6;
        }
        
        .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background-color: #3b82f6;
            color: white;
        }
        
        /* Memperbaiki tampilan search input di dropdown */
        .choices__list--dropdown .choices__input {
            background-color: transparent;
            border: none;
            outline: none;
            font-size: 1rem;
            padding: 0.75rem;
            width: 100%;
            box-sizing: border-box;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 0.5rem;
        }
        
        .choices__list--dropdown .choices__input::placeholder {
            color: #9ca3af;
            font-style: italic;
        }
        
        /* Memperbaiki tampilan placeholder */
        .choices__placeholder {
            color: #6b7280;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        /* Memperbaiki tampilan no results message */
        .choices__list--dropdown .choices__item--no-results {
            color: #6b7280;
            font-style: italic;
            padding: 0.75rem;
            text-align: center;
            background-color: #f9fafb;
        }
        
        .choices__placeholder {
            color: #6b7280;
        }
        
        .choices.is-focused .choices__inner {
            border-color: #3b82f6;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }
        
        /* Memperbaiki tampilan saat dropdown terbuka */
        .choices.is-open .choices__inner {
            border-color: #3b82f6;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }
        
        /* Memperbaiki tampilan arrow indicator */
        .choices__list--single .choices__item:after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #6b7280;
            pointer-events: none;
        }
        
        .choices.is-open .choices__list--single .choices__item:after {
            border-top: none;
            border-bottom: 5px solid #6b7280;
        }
        
        .choices.is-invalid .choices__inner {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        /* Memastikan ukuran dropdown sama dengan form-control */
        .modal-body .choices {
            width: 100%;
        }
        
        .modal-body .choices__inner {
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .modal-body .choices__input {
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .modal-body .choices__placeholder {
            font-size: 1rem;
            line-height: 1.5;
        }
        
        /* Memastikan dropdown list memiliki ukuran yang konsisten */
        .modal-body .choices__list--dropdown {
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .modal-body .choices__list--dropdown .choices__item {
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        /* Memastikan semua dropdown memiliki ukuran yang sama dengan form-control */
        .modal-body .form-control,
        .modal-body .choices__inner {
            height: 38px !important;
            min-height: 38px !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            border-radius: 0.5rem !important;
            border: 1px solid #d1d5db !important;
            box-sizing: border-box !important;
            width: 100% !important;
        }
        
        /* CSS khusus untuk dropdown di modal tambah proposal */
        #modalPengajuan .form-select,
        #modalEditProposal .form-select {
            height: 38px !important;
            min-height: 38px !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            border-radius: 0.5rem !important;
            border: 1px solid #d1d5db !important;
            box-sizing: border-box !important;
            width: 100% !important;
            background-color: #fff !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 0.75rem center !important;
            background-size: 16px 12px !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
        }
        
        /* Hover state untuk dropdown */
        #modalPengajuan .form-select:hover,
        #modalEditProposal .form-select:hover {
            border-color: #3b82f6 !important;
        }
        
        /* Focus state untuk dropdown */
        #modalPengajuan .form-select:focus,
        #modalEditProposal .form-select:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25) !important;
            outline: none !important;
        }
        
        /* Memastikan semua input di modal memiliki ukuran yang konsisten */
        #modalPengajuan .form-control,
        #modalPengajuan .form-select,
        #modalEditProposal .form-control,
        #modalEditProposal .form-select {
            height: 38px !important;
            min-height: 38px !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            border-radius: 0.5rem !important;
            border: 1px solid #d1d5db !important;
            box-sizing: border-box !important;
            width: 100% !important;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
        }
        
        /* Hover state untuk semua input */
        #modalPengajuan .form-control:hover,
        #modalPengajuan .form-select:hover,
        #modalEditProposal .form-control:hover,
        #modalEditProposal .form-select:hover {
            border-color: #3b82f6 !important;
        }
        
        /* Focus state untuk semua input */
        #modalPengajuan .form-control:focus,
        #modalPengajuan .form-select:focus,
        #modalEditProposal .form-control:focus,
        #modalEditProposal .form-select:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25) !important;
            outline: none !important;
        }
        
        /* Khusus untuk file input */
        #modalPengajuan input[type="file"],
        #modalEditProposal input[type="file"] {
            height: 38px !important;
            min-height: 38px !important;
            max-height: 38px !important;
            padding: 0 !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            border-radius: 0.5rem !important;
            border: 1px solid #d1d5db !important;
            box-sizing: border-box !important;
            width: 100% !important;
            background-color: #fff !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        /* Styling untuk tombol "Pilih File" */
        #modalPengajuan input[type="file"]::-webkit-file-upload-button,
        #modalEditProposal input[type="file"]::-webkit-file-upload-button {
            height: 100% !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            border: none !important;
            border-radius: 0.375rem 0 0 0.375rem !important;
            background-color: #f3f4f6 !important;
            color: #374151 !important;
            cursor: pointer !important;
            margin: 0 !important;
            font-weight: 500 !important;
            min-width: 100px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Hover state untuk tombol "Pilih File" */
        #modalPengajuan input[type="file"]::-webkit-file-upload-button:hover,
        #modalEditProposal input[type="file"]::-webkit-file-upload-button:hover {
            background-color: #e5e7eb !important;
        }
        
        /* Styling untuk text area file input */
        #modalPengajuan input[type="file"]::after,
        #modalEditProposal input[type="file"]::after {
            content: var(--file-name, "Tidak ada file yang dipilih") !important;
            display: flex !important;
            align-items: center !important;
            padding: 0.375rem 0.75rem !important;
            color: var(--file-color, #6b7280) !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            background-color: transparent !important;
            border: none !important;
            position: absolute !important;
            left: 100px !important;
            top: 0 !important;
            right: 0 !important;
            height: 100% !important;
            pointer-events: none !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
        
        /* Styling untuk file input di Firefox */
        #modalPengajuan input[type="file"]::-moz-file-upload-button,
        #modalEditProposal input[type="file"]::-moz-file-upload-button {
            height: 100% !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            border: none !important;
            border-radius: 0.375rem 0 0 0.375rem !important;
            background-color: #f3f4f6 !important;
            color: #374151 !important;
            cursor: pointer !important;
            margin: 0 !important;
            font-weight: 500 !important;
            min-width: 100px !important;
        }
        
        /* Styling untuk file input di Edge */
        #modalPengajuan input[type="file"]::-ms-browse,
        #modalEditProposal input[type="file"]::-ms-browse {
            height: 100% !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            border: none !important;
            border-radius: 0.375rem 0 0 0.375rem !important;
            background-color: #f3f4f6 !important;
            color: #374151 !important;
            cursor: pointer !important;
            margin: 0 !important;
            font-weight: 500 !important;
            min-width: 100px !important;
        }
        

        
        /* Hover state untuk file input */
        #modalPengajuan input[type="file"]:hover,
        #modalEditProposal input[type="file"]:hover {
            border-color: #3b82f6 !important;
        }
        
        /* Focus state untuk file input */
        #modalPengajuan input[type="file"]:focus,
        #modalEditProposal input[type="file"]:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25) !important;
            outline: none !important;
        }
        
        /* Khusus untuk number input */
        #modalPengajuan input[type="number"],
        #modalEditProposal input[type="number"] {
            height: 38px !important;
            min-height: 38px !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            border-radius: 0.5rem !important;
            border: 1px solid #d1d5db !important;
            box-sizing: border-box !important;
            width: 100% !important;
        }
        
        /* Styling untuk label di modal */
        #modalPengajuan .form-label,
        #modalEditProposal .form-label {
            font-weight: 500 !important;
            color: #374151 !important;
            margin-bottom: 0.5rem !important;
            font-size: 0.875rem !important;
        }
        
        /* Styling untuk small text di modal */
        #modalPengajuan .text-muted,
        #modalEditProposal .text-muted {
            font-size: 0.75rem !important;
            color: #6b7280 !important;
        }
        
        /* Styling untuk input readonly */
        #modalTambahAnggota input[readonly] {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
            border-color: #dee2e6 !important;
        }
        
        #modalTambahAnggota input[readonly]:focus {
            border-color: #dee2e6 !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        /* Memastikan dropdown container memiliki width yang sama */
        .modal-body .choices {
            width: 100% !important;
        }
        
        .modal-body .choices__inner {
            width: 100% !important;
            display: flex !important;
            align-items: center !important;
        }
        
        /* Memastikan placeholder dan input memiliki ukuran yang sama */
        .modal-body .choices__input,
        .modal-body .choices__placeholder {
            font-size: 1rem !important;
            line-height: 1.5 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        /* Memperbaiki tampilan dropdown list */
        .modal-body .choices__list--dropdown {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
            max-height: 250px !important;
            overflow-y: auto !important;
            background-color: #fff !important;
            z-index: 1050 !important;
            padding: 0 !important;
        }
        
        /* Memperbaiki scrollbar untuk dropdown */
        .modal-body .choices__list--dropdown::-webkit-scrollbar {
            width: 6px !important;
        }
        
        .modal-body .choices__list--dropdown::-webkit-scrollbar-track {
            background: #f1f1f1 !important;
            border-radius: 3px !important;
        }
        
        .modal-body .choices__list--dropdown::-webkit-scrollbar-thumb {
            background: #c1c1c1 !important;
            border-radius: 3px !important;
        }
        
        .modal-body .choices__list--dropdown::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8 !important;
        }
        
        .modal-body .choices__list--dropdown .choices__item {
            padding: 0.5rem 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            cursor: pointer !important;
            transition: background-color 0.2s !important;
        }
        
        .modal-body .choices__list--dropdown .choices__item--selectable:hover {
            background-color: #f3f4f6 !important;
        }
        
        .modal-body .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background-color: #3b82f6 !important;
            color: white !important;
        }
        
        /* Memperbaiki tampilan item yang dipilih */
        .modal-body .choices__list--single .choices__item {
            color: #374151 !important;
            font-weight: 500 !important;
        }
        
        /* Memperbaiki tampilan saat dropdown terbuka */
        .modal-body .choices.is-open .choices__inner {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25) !important;
        }
            row-gap: 18px;
        }

        @media (max-width: 575.98px) {

            .modal-header,
            .modal-footer,
            .modal-body {
                padding-left: 12px;
                padding-right: 12px;
            }

            .modal-body {
                padding-top: 16px;
                padding-bottom: 6px;
            }
            
            #detailFileProposalBtn {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            #detailStatus {
                font-size: 10px;
                padding: 4px 8px;
                min-width: 70px;
            }
            
            #detailFileProposalText {
                font-size: 12px;
                padding: 4px 8px;
            }
        }

        .btn-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 1rem;
            border: none;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.07);
            transition: box-shadow 0.2s;
        }

        .btn-circle:active,
        .btn-circle:focus {
            outline: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.13);
        }

        .btn-circle i {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-size: 1.1em;
            line-height: 1;
        }

        .status-dot {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 7px;
            vertical-align: middle;
        }

        .status-draf {
            background: #facc15;
        }

        .status-text {
            font-weight: 500;
            color: #444;
        }

        /* Styling untuk alert notifications */
        .alert {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .alert-warning {
            border-left-color: #ffc107;
        }
        
        .alert-success {
            border-left-color: #28a745;
        }
        
        .alert-danger {
            border-left-color: #dc3545;
        }
        
        .alert:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }
        
        .alert .btn-close {
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .alert .btn-close:hover {
            opacity: 1;
        }
        
        .alert i {
            flex-shrink: 0;
        }
        
        /* Styling untuk tombol file proposal */
        #detailFileProposalBtn {
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #435ebe;
            background: linear-gradient(135deg, #435ebe 0%, #5a6fd8 100%);
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(67, 94, 190, 0.2);
        }
        
        #detailFileProposalBtn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease-in-out;
            z-index: 1;
        }
        
        #detailFileProposalBtn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.8s ease-in-out;
            z-index: 1;
        }
        
        #detailFileProposalBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 94, 190, 0.4), 0 0 20px rgba(67, 94, 190, 0.3);
            border-color: #5a6fd8;
            filter: brightness(1.1);
            letter-spacing: 0.5px;
        }
        
        #detailFileProposalBtn:hover::before {
            left: 100%;
        }
        
        #detailFileProposalBtn:hover::after {
            left: 100%;
        }
        
        #detailFileProposalBtn:active {
            transform: translateY(0);
            box-shadow: 0 3px 12px rgba(67, 94, 190, 0.3);
            letter-spacing: normal;
        }
        
        #detailFileProposalBtn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 94, 190, 0.3), 0 6px 20px rgba(67, 94, 190, 0.4);
            letter-spacing: 0.5px;
        }
        
        #detailFileProposalBtn:focus-visible {
            outline: 2px solid #435ebe;
            outline-offset: 2px;
        }
        
        #detailFileProposalBtn i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        #detailFileProposalBtn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: 0 2px 8px rgba(67, 94, 190, 0.2) !important;
            letter-spacing: normal !important;
        }
        
        #detailFileProposalBtn:disabled:hover {
            transform: none !important;
            box-shadow: 0 2px 8px rgba(67, 94, 190, 0.2) !important;
            letter-spacing: normal !important;
            filter: none !important;
        }
        
        #detailFileProposalText {
            font-style: italic;
            color: #6c757d;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #6c757d;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #detailFileProposalText i {
            color: #dc3545;
            font-size: 16px;
        }
        
        #detailFileProposalText {
            animation: fadeInUp 0.5s ease-out 0.1s both;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #detailFileProposalText:hover {
            background: #e9ecef;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left-color: #dc3545;
        }
        
        #detailFileProposalText:focus {
            outline: 2px solid #435ebe;
            outline-offset: 2px;
        }
        
        /* Styling untuk badge status */
        #detailStatus {
            font-weight: 700;
            letter-spacing: 0.5px;
            border-radius: 8px;
            min-width: 90px;
            text-align: center;
            padding: 8px 16px;
            font-size: 12px;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.5s ease-out 0.2s both, bounce 0.6s ease-out 0.7s both;
            position: relative;
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0, 0, 0);
            }
            40%, 43% {
                transform: translate3d(0, -8px, 0);
            }
            70% {
                transform: translate3d(0, -4px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }
        
        #detailStatus:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: pulse 1s infinite;
            cursor: pointer;
            filter: brightness(1.1);
        }
        
        #detailStatus:focus {
            outline: 2px solid #435ebe;
            outline-offset: 2px;
        }
        
        #detailStatus:hover::after {
            content: '👆';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            animation: bounce 0.6s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: translateY(-1px) scale(1);
            }
            50% {
                transform: translateY(-1px) scale(1.05);
            }
            100% {
                transform: translateY(-1px) scale(1);
            }
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-10px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes loading-dots {
            0%, 20% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }
        
        .loading-dots {
            animation: loading-dots 1.5s infinite;
        }
        
        .loading-dots::after {
            content: '';
            animation: loading-dots 1.5s infinite 0.5s;
        }
        
        .loading-dots::before {
            content: '';
            animation: loading-dots 1.5s infinite 1s;
        }
        
        /* Animasi untuk tombol file proposal */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #detailFileProposalBtn {
            animation: fadeInUp 0.5s ease-out;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Efek ripple untuk tombol */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* Responsive untuk file proposal section */
        @media (max-width: 768px) {
            .d-flex.justify-content-between {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 12px;
            }
            
            #detailFileProposalBtn {
                width: 100%;
                justify-content: center;
                font-size: 13px;
                padding: 8px 16px;
            }
            
            #detailStatus {
                align-self: flex-end;
                font-size: 11px;
                padding: 6px 12px;
                min-width: 80px;
            }
            
            #detailFileProposalText {
                font-size: 13px;
                padding: 6px 10px;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            #detailFileProposalBtn {
                font-size: 13px;
                padding: 9px 18px;
            }
            
            #detailStatus {
                font-size: 11px;
                padding: 7px 14px;
                min-width: 85px;
            }
            
            #detailFileProposalText {
                font-size: 13px;
                padding: 7px 11px;
            }
        }
        
        @media (min-width: 1025px) {
            #detailFileProposalBtn {
                font-size: 14px;
                padding: 10px 20px;
            }
            
            #detailStatus {
                font-size: 12px;
                padding: 8px 16px;
                min-width: 90px;
            }
            
            #detailFileProposalText {
                font-size: 14px;
                padding: 8px 12px;
            }
        }
        
        @media (min-width: 1400px) {
            #detailFileProposalBtn {
                font-size: 15px;
                padding: 12px 24px;
            }
            
            #detailStatus {
                font-size: 13px;
                padding: 10px 20px;
                min-width: 100px;
            }
            
            #detailFileProposalText {
                font-size: 15px;
                padding: 10px 16px;
            }
        }
        
        @media (min-width: 1920px) {
            #detailFileProposalBtn {
                font-size: 16px;
                padding: 14px 28px;
            }
            
            #detailStatus {
                font-size: 14px;
                padding: 12px 24px;
                min-width: 110px;
            }
            
            #detailFileProposalText {
                font-size: 16px;
                padding: 12px 20px;
            }
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            #detailFileProposalBtn {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            #detailStatus {
                font-size: 10px;
                padding: 4px 8px;
                min-width: 70px;
            }
            
            #detailFileProposalText {
                font-size: 12px;
                padding: 4px 8px;
            }
        }
        
        @media (orientation: portrait) and (max-width: 768px) {
            #detailFileProposalBtn {
                font-size: 13px;
                padding: 8px 16px;
            }
            
            #detailStatus {
                font-size: 11px;
                padding: 6px 12px;
                min-width: 80px;
            }
            
            #detailFileProposalText {
                font-size: 13px;
                padding: 6px 10px;
            }
        }
        
        @media (prefers-color-scheme: dark) {
            #detailFileProposalBtn {
                background: linear-gradient(135deg, #5a6fd8 0%, #7c3aed 100%);
                border-color: #5a6fd8;
            }
            
            #detailFileProposalBtn:hover {
                background: linear-gradient(135deg, #7c3aed 0%, #9f7aea 100%);
                border-color: #7c3aed;
            }
            
            #detailFileProposalText {
                background: #2d3748;
                color: #a0aec0;
                border-left-color: #e53e3e;
            }
            
            #detailFileProposalText:hover {
                background: #4a5568;
                color: #e2e8f0;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            #detailFileProposalBtn,
            #detailStatus,
            #detailFileProposalText {
                animation: none !important;
                transition: none !important;
            }
            
            #detailFileProposalBtn:hover,
            #detailStatus:hover,
            #detailFileProposalText:hover {
                transform: none !important;
                animation: none !important;
            }
            
            .ripple,
            .loading-dots {
                animation: none !important;
            }
        }
        
        @media (prefers-contrast: high) {
            #detailFileProposalBtn {
                border-width: 3px;
                box-shadow: 0 0 0 2px #000;
            }
            
            #detailStatus {
                border: 2px solid #000;
                font-weight: 900;
            }
            
            #detailFileProposalText {
                border-left-width: 5px;
                font-weight: 700;
            }
        }
        
        @media print {
            #detailFileProposalBtn {
                display: none !important;
            }
            
            #detailStatus {
                background: #000 !important;
                color: #fff !important;
                border: 2px solid #000 !important;
            }
            
            #detailFileProposalText {
                background: #f0f0f0 !important;
                color: #000 !important;
                border-left-color: #000 !important;
            }
        }
        
        /* Styling untuk keyboard navigation */
        [tabindex]:focus {
            outline: 2px solid #435ebe;
            outline-offset: 2px;
        }
        
        [tabindex]:focus-visible {
            outline: 2px solid #435ebe;
            outline-offset: 2px;
        }
        
        /* Styling untuk screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        }
        
        /* Responsive untuk form proposal */
        @media (max-width: 768px) {
            .form-section {
                margin-bottom: 2rem;
            }
            
            .form-section h5 {
                font-size: 1.25rem !important;
                margin-bottom: 1rem;
            }
            
            .anggota-section {
                margin-top: 1.5rem;
            }
            
            .anggota-card {
                margin-bottom: 1rem;
            }
            
            .btn-tambah-anggota {
                width: 100%;
                justify-content: center;
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .form-section h5 {
                font-size: 1.1rem !important;
            }
            
            .form-label {
                font-size: 0.9rem !important;
                margin-bottom: 0.5rem;
            }
            
            .form-control, .form-select {
                font-size: 0.9rem !important;
                padding: 0.5rem 0.75rem;
            }
            
            .btn {
                font-size: 0.9rem !important;
                padding: 0.5rem 1rem;
            }
            
            .card-body {
                padding: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .form-section h5 {
                font-size: 1rem !important;
            }
            
            .form-label {
                font-size: 0.8rem !important;
            }
            
            .form-control, .form-select {
                font-size: 0.8rem !important;
                padding: 0.375rem 0.5rem;
            }
            
            .btn {
                font-size: 0.8rem !important;
                padding: 0.375rem 0.75rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }
        }
        
        @media (max-width: 768px) {
            .alert {
                padding: 12px 16px;
            }
            
            .alert .d-flex {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            .alert i {
                margin-bottom: 8px;
                margin-right: 0 !important;
            }
        }

        /* Styling untuk tombol Tambah Usulan */
        .btn-tambah-usulan-custom {
            display: inline-flex;
            align-items: center;
            background: #4b7c5a;
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 6px 22px 6px 10px;
            font-weight: 600;
            font-size: 1rem;
            transition: background 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            gap: 10px;
        }
        
        .btn-tambah-usulan-custom:hover {
            background: #356346;
        }
        
        .btn-tambah-usulan-custom .icon-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            color: #388e3c;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            margin-right: 8px;
            font-size: 1.4em;
            font-weight: bold;
            box-shadow: 0 1px 4px rgba(0,0,0,0.07);
            line-height: 1;
        }

        .btn-tambah-usulan-custom .bi-plus {
            font-weight: bold !important;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        /* Styling untuk tombol warning saat belum mencapai minimal anggota */
        .btn-warning {
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
            color: #212529 !important;
        }
        
        .btn-warning:hover {
            background-color: #e0a800 !important;
            border-color: #d39e00 !important;
            color: #212529 !important;
        }
        
        .btn-warning:focus {
            background-color: #e0a800 !important;
            border-color: #d39e00 !important;
            color: #212529 !important;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.5) !important;
        }

        /* Responsive design untuk tombol tambah usulan */
        @media (max-width: 768px) {
            .d-flex.justify-content-between.align-items-center.mb-2.flex-nowrap {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .d-flex.justify-content-between.align-items-center.mb-2.flex-nowrap > div:first-child {
                width: 100%;
            }
            
            .d-flex.justify-content-between.align-items-center.mb-2.flex-nowrap .btn-tambah-usulan-custom {
                align-self: flex-end;
                margin-left: auto;
            }
        }

        @media (max-width: 576px) {
            .btn-tambah-usulan-custom {
                padding: 6px 16px 6px 8px;
                font-size: 0.9rem;
            }
            
            .btn-tambah-usulan-custom .icon-circle {
                width: 28px;
                height: 28px;
                font-size: 1.2em;
            }
        }

        /* Memastikan tombol tetap di pojok kanan saat zoom */
        @media (min-width: 769px) {
            .d-flex.justify-content-between.align-items-center.mb-2.flex-nowrap {
                min-width: 0;
            }
            
            .d-flex.justify-content-between.align-items-center.mb-2.flex-nowrap > div:first-child {
                flex: 1;
                min-width: 0;
                margin-right: 15px;
            }
            
            .d-flex.justify-content-between.align-items-center.mb-2.flex-nowrap .btn-tambah-usulan-custom {
                flex-shrink: 0;
                white-space: nowrap;
            }
        }

        .anggota-card {
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .anggota-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-color: #22c55e !important;
        }

        .anggota-card .card-header {
            transition: all 0.3s ease;
        }

        .anggota-card:hover .card-header {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
        }

        .btn-hapus-anggota {
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.8) !important;
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(5px);
        }

        .btn-hapus-anggota:hover {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: white !important;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-hapus-anggota:active {
            transform: scale(0.95);
        }

        /* Modal Detail Proposal Styling */
        #modalLihatProposal .modal-header {
            background: #f8f9fa;
            color: #3b3f5c;
            border-bottom: 1px solid #dee2e6;
        }

        #modalLihatProposal .modal-header .btn-close {
            filter: none;
        }

        /* Tab Styling */
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            color: #435ebe;
            background-color: #f8f9fa;
            border-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: #435ebe;
            background-color: #fff;
            border-bottom: 3px solid #435ebe;
            font-weight: 600;
        }

        .nav-tabs .nav-link i {
            margin-right: 8px;
        }

        /* Form Control Plaintext Styling */
        .form-control-plaintext {
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            color: #495057;
            font-weight: 500;
        }

        /* Table Styling */
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }



        /* Badge Styling */
        .badge {
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        /* File Link Styling */
        #detailFileProposal {
            color: #435ebe;
            font-weight: 500;
        }

        #detailFileProposal:hover {
            color: #25396f;
            text-decoration: underline !important;
        }

        /* No Data Message Styling */
        #noAnggotaMessage {
            color: #6c757d;
        }

        #noAnggotaMessage i {
            color: #dee2e6;
        }

        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34,197,94,0.15) !important;
            border-color: #22c55e !important;
        }

        /* Perbaikan untuk modal yang tidak bisa ditutup */
        .modal {
            z-index: 1055 !important;
        }
        
        .modal-backdrop {
            z-index: 1050 !important;
        }
        
        /* Memastikan modal bisa ditutup dengan klik di luar */
        .modal.show {
            display: block !important;
        }
        
        /* Perbaikan untuk backdrop yang stuck */
        body.modal-open {
            overflow: hidden !important;
            padding-right: 0 !important;
        }
        
        /* Memastikan backdrop bisa diklik */
        .modal-backdrop {
            cursor: pointer !important;
            z-index: 1050 !important;
        }
        
        /* Memastikan modal tidak menghalangi backdrop */
        .modal {
            pointer-events: none !important;
        }
        
        .modal .modal-dialog {
            pointer-events: auto !important;
        }
        
        /* Force close modal jika ada masalah */
        .modal-force-close {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        /* Perbaikan untuk tombol close modal */
        .btn-close {
            cursor: pointer !important;
            z-index: 1060 !important;
        }
        
        .btn-close:focus {
            box-shadow: none !important;
        }
        
        /* Perbaikan untuk backdrop modal */
        .modal-backdrop {
            z-index: 1040 !important;
            cursor: pointer !important;
        }
        
        .modal {
            z-index: 1050 !important;
        }
        
        /* Memastikan modal bisa ditutup dengan klik di backdrop */
        .modal.show {
            display: block !important;
        }
        
        /* Perbaikan untuk pointer events */
        .modal-dialog {
            pointer-events: auto !important;
        }
        
        .modal-content {
            pointer-events: auto !important;
        }
        
        /* Memastikan backdrop bisa diklik */
        .modal-backdrop.show {
            opacity: 0.5 !important;
            pointer-events: auto !important;
        }
        
        /* Perbaikan untuk modal yang tidak bisa ditutup */
        .modal.show {
            display: block !important;
            pointer-events: auto !important;
        }
        
        /* Memastikan body tidak scroll saat modal terbuka */
        body.modal-open {
            overflow: hidden !important;
            padding-right: 0 !important;
        }

        #modalEditProposal .modal-body hr {
            margin-top: 8px !important;
            margin-bottom: 8px !important;
        }
        #modalEditProposal .modal-body h6 {
            margin-bottom: 8px !important;
            margin-top: 0 !important;
            font-weight: 700;
        }

        #modalEditProposal .modal-body .row.g-3 {
            margin-bottom: 0 !important;
        }
        #modalEditProposal .modal-body hr {
            margin-top: 4px !important;
            margin-bottom: 8px !important;
        }
        #modalEditProposal .modal-body h6 {
            margin-bottom: 6px !important;
            margin-top: 0 !important;
            font-weight: 700;
        }
        #modalEditProposal .row.g-3.align-items-center {
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }
        #modalEditProposal .modal-body .col-12 {
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }
    </style>

    <link rel="stylesheet"
        href="{{ url_for('static', filename='assets/vendors/perfect-scrollbar/perfect-scrollbar.css') }}">
    <link rel="stylesheet"
        href="{{ url_for('static', filename='assets/vendors/bootstrap-icons/bootstrap-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/app.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/responsive-mahasiswa.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='assets/images/favicon.svg') }}" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{{ url_for('static', filename='assets/vendors/toastify/toastify.js') }}"></script>
    
    <!-- Script untuk menangani warning passive event listeners -->
    <script>
        // Suppress passive event listener warnings
        const originalAddEventListener = EventTarget.prototype.addEventListener;
        EventTarget.prototype.addEventListener = function(type, listener, options) {
            if (type === 'touchstart' || type === 'wheel') {
                if (typeof options === 'object') {
                    options.passive = true;
                } else if (typeof options === 'boolean') {
                    options = { passive: true, capture: options };
                } else {
                    options = { passive: true };
                }
            }
            return originalAddEventListener.call(this, type, listener, options);
        };
    </script>
</head>

<body>
    <div id="app">
        <div id="sidebar" class="active">
            <div class="sidebar-wrapper active">
                <div class="sidebar-header">
                    <div class="d-flex justify-content-between">
                        <div class="logo">
                            <a href="{{ url_for('mahasiswa.dashboard_mahasiswa') }}"><img
                                    src="{{ url_for('static', filename='assets/images/logo/logo.svg') }}" style="width: 110px; height: auto;" alt="Logo"
                                    srcset=""></a>
                        </div>
                        <div class="toggler">
                            <a href="#" class="sidebar-hide d-xl-none d-block"><i class="bi bi-x bi-middle"></i></a>
                        </div>
                    </div>
                </div>
                <div class="sidebar-menu">
                    <ul class="menu">
                        <li class="sidebar-title">Menu</li>

                        <li class="sidebar-item">
                            <a href="{{ url_for('mahasiswa.dashboard_mahasiswa') }}" class='sidebar-link'>
                                <i class="bi bi-speedometer2"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>

                        {% if has_lolos_proposal %}
                            <!-- Menu untuk mahasiswa dengan proposal status_admin = 'lolos' - lengkap -->
                            <li class="sidebar-item active has-sub">
                                <a href="#" class='sidebar-link'>
                                    <i class="bi bi-cash-stack"></i>
                                    <span>Pendanaan Hibah</span>
                                </a>
                                <ul class="submenu active">
                                    <li class="submenu-item active">
                                        <a href="{{ url_for('mahasiswa.proposal') }}">Pengajuan Proposal</a>
                                    </li>
                                    <li class="submenu-item ">
                                        <a href="{{ url_for('mahasiswa.laporan_kemajuan') }}">Laporan Kemajuan</a>
                                    </li>
                                    <li class="submenu-item ">
                                        <a href="{{ url_for('mahasiswa.laporan_akhir') }}">Laporan Akhir</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-item  has-sub">
                                <a href="#" class='sidebar-link'>
                                    <i class="bi bi-gear-fill"></i>
                                    <span>Produksi</span>
                                </a>
                                <ul class="submenu ">
                                    <li class="submenu-item ">
                                        <a href="{{ url_for('mahasiswa.pengelolaan_bahan_baku_mahasiswa') }}">Bahan Baku</a>
                                    </li>
                                    <li class="submenu-item ">
                                        <a href="{{ url_for('mahasiswa.aktivitas_produksi_mahasiswa') }}">Produksi</a>
                                    </li>
                                </ul>
                            </li>

                            <li class="sidebar-item ">
                                <a href="{{ url_for('mahasiswa.pembelian_alat_mahasiswa') }}" class='sidebar-link'>
                                    <i class="bi bi-tools"></i>
                                    <span>Alat Produksi</span>
                                </a>    
                            </li>
                            <li class="sidebar-item ">
                                <a href="{{ url_for('mahasiswa.biaya_operasional_mahasiswa') }}" class='sidebar-link'>
                                    <i class="bi bi-calculator"></i>
                                    <span>Biaya Operasional</span>
                                </a>
                            </li>
                            <li class="sidebar-item ">
                                <a href="{{ url_for('mahasiswa.biaya_non_operasional_mahasiswa') }}" class='sidebar-link'>
                                    <i class="bi bi-wallet2"></i>
                                    <span>Biaya Lain-lain</span>
                                </a>
                            </li>
                            <li class="sidebar-item ">
                                <a href="{{ url_for('mahasiswa.laporan_penjualan_mahasiswa') }}" class='sidebar-link'>
                                    <i class="bi bi-receipt"></i>
                                    <span>Laporan Penjualan</span>
                                </a>
                                
                            </li>
                            
                            <li class="sidebar-item  has-sub">
                                <a href="#" class='sidebar-link'>
                                    <i class="bi bi-graph-up"></i>
                                    <span>Pelaporan Keuangan</span>
                                </a>
                                <ul class="submenu ">
                                    <li class="submenu-item ">
                                        <a href="{{ url_for('mahasiswa.laporan_laba_rugi_mahasiswa') }}">Laporan Laba Rugi</a>
                                    </li>
                                    <li class="submenu-item ">
                                        <a href="{{ url_for('mahasiswa.laporan_arus_kas_mahasiswa') }}">Laporan Arus Kas</a> 
                                    </li>
                                    <li class="submenu-item ">
                                        <a href="{{ url_for('mahasiswa.laporan_neraca_mahasiswa') }}">Laporan Neraca</a>
                                    </li>
                                </ul>
                            </li>
                        {% else %}
                            <!-- Menu untuk mahasiswa dengan proposal status_admin != 'lolos' atau tanpa proposal - terbatas -->
                            <li class="sidebar-item active has-sub">
                                <a href="#" class='sidebar-link'>
                                    <i class="bi bi-cash-stack"></i>
                                    <span>Pendanaan Hibah</span>
                                </a>
                                <ul class="submenu active">
                                    <li class="submenu-item active">
                                        <a href="{{ url_for('mahasiswa.proposal') }}">Pengajuan Proposal</a>
                                    </li>
                                </ul>
                            </li>
                        {% endif %}
                        <li class="sidebar-item ">
                            <a href="{{ url_for('mahasiswa.bimbingan') }}" class='sidebar-link'>
                                <i class="bi bi-chat-dots"></i>
                                <span>Bimbingan</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="{{ url_for('mahasiswa.profile_mahasiswa') }}" class='sidebar-link'>
                                <i class="bi bi-person-circle"></i>
                                <span>Profile Mahasiswa</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="{{ url_for('mahasiswa.nilai_mahasiswa') }}" class='sidebar-link'>
                                <i class="bi bi-star-fill"></i>
                                <span>Nilai Mahasiswa</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="{{ url_for('logout') }}" class='sidebar-link'>
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Logout</span>
                            </a>
                        </li>

                    </ul>
                </div>
                <button class="sidebar-toggler btn x"><i data-feather="x"></i></button>
            </div>
        </div>
        <div id="main">
            <header class="mb-3">
                <a href="#" class="burger-btn d-block d-xl-none">
                    <i class="bi bi-justify fs-3"></i>
                </a>
            </header>

            <div class="page-heading">
                <div class="page-title">
                    <div class="row">
                        <div class="col-12 col-md-6 order-md-1 order-last">
                            <h3>Halaman Manajemen Pengajuan</h3>
                            <p class="text-subtitle text-muted" style="font-size:1.2rem;">Buat dan kelola proposal bisnismu di AYMP UNJAYA.</p>
                        </div>
                        <div class="col-12 col-md-6 order-md-2 order-first">
                            <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Manajemen Pengajuan</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Basic Tables start -->
                <section class="section">
                    
                    <div class="container-fluid mt-4">

                        <!-- Alert Status Mahasiswa -->
                        {% if status_mahasiswa == 'proses' %}
                        <div class="alert alert-warning alert-dismissible fade show" role="alert"
                            style="border-radius: 12px; border: none; background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%); color: #856404; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock me-3" style="font-size: 1.2rem; color: #ffc107;"></i>
                                <div>
                                    <strong style="color: #856404;">Akun Belum Diverifikasi!</strong>
                                    <p class="mb-0 mt-1" style="font-size: 0.95rem; color: #856404;">
                                        Akun Anda masih dalam proses verifikasi oleh admin. Anda tidak dapat menambahkan proposal, anggaran, atau anggota tim sampai akun diverifikasi.
                                    </p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% elif status_mahasiswa == 'tolak' %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert"
                            style="border-radius: 12px; border: none; background: linear-gradient(135deg, #fdf2f2 0%, #f8d7da 100%); color: #721c24; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-times-circle me-3" style="font-size: 1.2rem; color: #dc3545;"></i>
                                <div>
                                    <strong style="color: #721c24;">Akun Ditolak!</strong>
                                    <p class="mb-0 mt-1" style="font-size: 0.95rem; color: #721c24;">
                                        Akun Anda ditolak oleh admin. Anda tidak dapat mengakses fitur pengajuan proposal. Silakan hubungi admin untuk informasi lebih lanjut.
                                    </p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% else %}
                        <!-- Alert Status Proposal -->
                        {% if status_mahasiswa == 'selesai' %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert"
                            style="border-radius: 12px; border: none; background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%); color: #0c5460; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(13, 202, 240, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-graduation-cap me-3" style="font-size: 1.2rem; color: #0dcaf0;"></i>
                                <div>
                                    <strong style="color: #0c5460;">Program Telah Selesai!</strong>
                                    <p class="mb-0 mt-1" style="font-size: 0.95rem; color: #0c5460;">
                                        Status akun Anda telah selesai. Anda tidak dapat membuat proposal baru atau mengakses fitur pengembangan usaha. Hubungi admin jika ada pertanyaan.
                                    </p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% elif proposals %}
                        {% set has_approved_proposal = false %}
                        {% set has_draft_proposal = false %}
                        {% set has_submitted_proposal = false %}
                        {% set has_rejected_proposal = false %}
                        {% set has_revision_proposal = false %}

                        {% for proposal in proposals %}
                        {% if proposal.status == 'disetujui' %}
                        {% set has_approved_proposal = true %}
                        {% elif proposal.status == 'draf' %}
                        {% set has_draft_proposal = true %}
                        {% elif proposal.status == 'diajukan' %}
                        {% set has_submitted_proposal = true %}
                        {% elif proposal.status == 'ditolak' %}
                        {% set has_rejected_proposal = true %}
                        {% elif proposal.status == 'revisi' %}
                        {% set has_revision_proposal = true %}
                        {% endif %}
                        {% endfor %}

                        {% if not has_approved_proposal %}
                        {% if has_draft_proposal %}
                        <div class="alert alert-warning alert-dismissible fade show" role="alert"
                            style="border-radius: 12px; border: none; background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%); color: #856404; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-edit me-3" style="font-size: 1.2rem; color: #ffc107;"></i>
                                <div>
                                    <strong style="color: #856404;">Proposal Masih Draf!</strong>
                                    <p class="mb-0 mt-1" style="font-size: 0.95rem; color: #856404;">
                                        Proposal Anda masih dalam status draf. Kirim proposal untuk mengakses menu
                                        lengkap.
                                    </p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% elif has_revision_proposal %}
                        <div class="alert alert-warning alert-dismissible fade show" role="alert"
                            style="border-radius: 12px; border: none; background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%); color: #856404; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.2rem; color: #ffc107;"></i>
                                <div>
                                    <strong style="color: #856404;">Proposal Perlu Revisi!</strong>
                                    <p class="mb-0 mt-1" style="font-size: 0.95rem; color: #856404;">
                                        Proposal Anda memerlukan revisi. Silakan lihat komentar pembimbing, edit proposal, dan kirim ulang.
                                    </p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% elif has_submitted_proposal %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert"
                            style="border-radius: 12px; border: none; background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%); color: #0c5460; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(13, 202, 240, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock me-3" style="font-size: 1.2rem; color: #0dcaf0;"></i>
                                <div>
                                    <strong style="color: #0c5460;">Proposal Sedang Ditinjau!</strong>
                                    <p class="mb-0 mt-1" style="font-size: 0.95rem; color: #0c5460;">
                                        Proposal Anda sedang dalam proses peninjauan. Menu lengkap akan tersedia setelah
                                        proposal disetujui.
                                    </p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% elif has_rejected_proposal %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert"
                            style="border-radius: 12px; border: none; background: linear-gradient(135deg, #fdf2f2 0%, #f8d7da 100%); color: #721c24; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-times-circle me-3" style="font-size: 1.2rem; color: #dc3545;"></i>
                                <div>
                                    <strong style="color: #721c24;">Proposal Ditolak!</strong>
                                    <p class="mb-0 mt-1" style="font-size: 0.95rem; color: #721c24;">
                                        Proposal Anda ditolak. Silakan buat proposal baru atau hubungi admin untuk
                                        informasi lebih lanjut.
                                    </p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert"
                            style="border-radius: 12px; border: none; background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); color: #155724; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle me-3" style="font-size: 1.2rem; color: #28a745;"></i>
                                <div>
                                    <strong style="color: #155724;">Proposal Disetujui!</strong>
                                    <p class="mb-0 mt-1" style="font-size: 0.95rem; color: #155724;">Proposal Anda telah disetujui. Anda
                                        dapat mengakses semua menu fitur.</p>
                            </div>
                        </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert"
                            style="border-radius: 12px; border: none; background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%); color: #0c5460; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(13, 202, 240, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle me-3" style="font-size: 1.2rem; color: #0dcaf0;"></i>
                                <div>
                                    <strong style="color: #0c5460;">Belum Ada Proposal!</strong>
                                    <p class="mb-0 mt-1" style="font-size: 0.95rem; color: #0c5460;">Anda belum memiliki proposal. Buat
                                        proposal pertama untuk memulai.</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endif %}
                        {% endif %}

                        <div class="card"
                            style="border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);padding:24px 18px 10px 18px;">
                            <div class="d-flex justify-content-between align-items-center mb-2 flex-nowrap">
                                <div>
                                    <div style="font-weight:700;font-size:1.45rem;">Pengajuan</div>
                                    <div
                                        style="font-size:1rem;font-weight:500;display:flex;flex-wrap:wrap;align-items:center;gap:6px 0;">
                                        <span style="color:#2196f3;font-weight:700;margin-right:6px;">Untuk Kategori
                                            :</span>
                                        <span style="color:#2196f3;">
                                            Makanan dan Minuman;
                                        </span>
                                        <span style="color:#2196f3;">Budidaya;</span>
                                        <span style="color:#2196f3;">Industri Kreatif;</span>
                                        <span style="color:#2196f3;">Seni dan Budaya;</span>
                                        <span style="color:#2196f3;">Jasa;</span>
                                        <span style="color:#2196f3;">Pariwisata dan Perdagangan;</span>
                                        <span style="color:#2196f3;">Manufaktur dan Teknologi Terapan;</span>
                                        <span style="color:#2196f3;">Bisnis Digital</span>
                                    </div>
                                </div>
                                <button class="btn btn-tambah-usulan-custom" id="btnTambahUsulan"
                                    {% if status_mahasiswa == 'proses' or status_mahasiswa == 'tolak' or status_mahasiswa == 'selesai' %}
                                        disabled style="opacity:0.6;cursor:not-allowed;" title="{% if status_mahasiswa == 'selesai' %}Program telah selesai{% else %}Tidak tersedia{% endif %}"
                                    {% elif proposals and proposals|length > 0 %}
                                        disabled style="opacity:0.6;cursor:not-allowed;" title="Anda sudah memiliki proposal"
                                    {% else %}
                                         onclick="handleTambahUsulanKlik()"
                                    {% endif %}>
                                    <span class="icon-circle">
                                        <i class="bi bi-plus"></i>
                                    </span>
                                    Tambah Usulan
                                </button>
                                

                            </div>
                            <div class="table-responsive">
                                <table class="table mb-0" id="table1">
                                <thead>
                                    <tr>
                                            <th>No</th>
                                            <th>Judul</th>
                                            <th>Kategori</th>
                                            <th>Status</th>
                                            <th>Tahun NIB</th>
                                            <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                        {% if proposals %}
                                        {% for proposal in proposals %}
                                        <tr data-tahapan="{{ proposal.tahapan_usaha }}" data-proposal-id="{{ proposal.id }}" data-status="{{ proposal.status }}" data-dosen-pembimbing="{{ proposal.dosen_pembimbing or '' }}">
                                            <td>{{ loop.index }}</td>
                                            <td>{{ proposal.judul_usaha|e }}</td>
                                            <td>{{ proposal.kategori|e }}</td>
                                            <td>
                                                {% if proposal.status == 'draf' %}
                                                <span class="status-dot status-draf"></span>
                                                <span class="status-text">Draf</span>
                                                {% elif proposal.status == 'diajukan' %}
                                                <span class="status-dot" style="background: #3b82f6;"></span>
                                                <span class="status-text">Diajukan</span>
                                                {% elif proposal.status == 'disetujui' %}
                                                    {% if proposal.status_admin == 'belum_ditinjau' %}
                                                        <span class="status-dot" style="background: #facc15;"></span>
                                                        <span class="status-text">Menunggu Verifikasi</span>
                                                    {% elif proposal.status_admin == 'lolos' %}
                                                        <span class="status-dot" style="background: #22c55e;"></span>
                                                        <span class="status-text">Lolos Pendanaan</span>
                                                    {% elif proposal.status_admin == 'tidak_lolos' %}
                                                        <span class="status-dot" style="background: #ef4444;"></span>
                                                        <span class="status-text">Tidak Lolos Pendanaan</span>
                                                    {% else %}
                                                        <span class="status-dot" style="background: #22c55e;"></span>
                                                        <span class="status-text">Disetujui</span>
                                                    {% endif %}
                                                {% elif proposal.status == 'ditolak' %}
                                                <span class="status-dot" style="background: #ef4444;"></span>
                                                <span class="status-text">Ditolak</span>
                                                {% elif proposal.status == 'revisi' %}
                                                <span class="status-dot" style="background: #f59e0b;"></span>
                                                <span class="status-text">Revisi</span>
                                                {% endif %}
                                        </td>
                                            <td>{% if proposal.tahun_nib and proposal.tahun_nib != '0' %}{{ proposal.tahun_nib }}{% else %}-{% endif %}</td>
                                            <td class="td-aksi">
                                                <button class="btn btn-circle" style="background:#102693;color:#fff;"
                                                    title="Lihat" onclick="lihatProposal({{ proposal.id }})">
                                                    <i class="fa-solid fa-eye"></i>
                                                </button>
                                                <button class="btn btn-circle" style="background:#facc15;color:#222;"
                                                    title="{% if status_mahasiswa == 'selesai' %}Tambah Anggota - Program selesai{% else %}Tambah Anggota ({{ jumlah_anggota_per_proposal[proposal.id] }}/4){% if jumlah_anggota_per_proposal[proposal.id] < 3 %} - Minimal 3{% endif %}{% endif %}" onclick="tambahAnggota({{ proposal.id }}, {{ jumlah_anggota_per_proposal[proposal.id] }})"
                                                    {% if status_mahasiswa == 'proses' or status_mahasiswa == 'tolak' or status_mahasiswa == 'selesai' or proposal.status == 'diajukan' or proposal.status == 'disetujui' or proposal.status == 'ditolak' %}disabled style="opacity:0.6;cursor:not-allowed;"{% endif %}>
                                                    <i class="fa-solid fa-users"></i>
                                                </button>
                                                <button class="btn btn-circle" style="background:#22b6d1;color:#fff;"
                                                    title="{% if status_mahasiswa == 'selesai' %}Anggaran - Program selesai{% else %}Anggaran{% endif %}"
                                                    onclick="keAnggaran({{ proposal.id }}, '{{ proposal.tahapan_usaha }}')"
                                                    {% if status_mahasiswa == 'proses' or status_mahasiswa == 'tolak' or status_mahasiswa == 'selesai' %}disabled style="opacity:0.6;cursor:not-allowed;"{% endif %}>
                                                    <i class="fa-solid fa-sack-dollar"></i>
                                                </button>
                                                <button class="btn btn-circle" style="background:#f472b6;color:#fff;"
                                                    title="{% if status_mahasiswa == 'selesai' %}Hapus - Program selesai{% else %}Hapus{% endif %}" onclick="hapusProposal({{ proposal.id }})"
                                                    {% if status_mahasiswa == 'proses' or status_mahasiswa == 'tolak' or status_mahasiswa == 'selesai' %}disabled style="opacity:0.6;cursor:not-allowed;"{% endif %}>
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                                {% if status_mahasiswa == 'aktif' and (proposal.status == 'draf' or proposal.status == 'revisi') %}
                                                <button class="btn btn-circle" style="background:#22c55e;color:#fff;"
                                                    title="Kirim" onclick="kirimProposal({{ proposal.id }})">
                                                    <i class="fa-solid fa-check"></i>
                                                </button>
                                                {% elif status_mahasiswa != 'aktif' and (proposal.status == 'draf' or proposal.status == 'revisi') %}
                                                <button class="btn btn-circle" style="background:#22c55e;color:#fff;opacity:0.6;cursor:not-allowed;"
                                                    title="{% if status_mahasiswa == 'selesai' %}Kirim - Program selesai{% else %}Kirim - Tidak tersedia{% endif %}" disabled>
                                                    <i class="fa-solid fa-check"></i>
                                                </button>
                                                {% endif %}
                                                {% if proposal.status == 'draf' %}
                                                <button class="btn btn-circle" style="background:#ffc107;color:#222;" title="Edit Proposal" onclick="editProposal({{ proposal.id }})"><i class="fa-solid fa-edit"></i></button>
                                                {% endif %}
                                                {% if proposal.status == 'revisi' %}
                                                <button class="btn btn-circle" style="background:#f59e0b;color:#fff;" title="Lihat Komentar Pembimbing" onclick="lihatKomentarPembimbing({{ proposal.id }}, '{{ proposal.komentar_pembimbing or '' }}', '{{ proposal.tanggal_komentar_pembimbing or '' }}')">
                                                    <i class="fa-solid fa-exclamation-triangle"></i>
                                                </button>
                                                <button class="btn btn-circle" style="background:#ffc107;color:#222;" title="Edit Proposal (Revisi)" onclick="editProposalRevisi({{ proposal.id }})"><i class="fa-solid fa-edit"></i></button>
                                                {% endif %}
                                        </td>
                                    </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center" style="padding: 20px;">Belum ada proposal</td>
                                        </tr>
                                        {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </section>
                <!-- Basic Tables end -->

    <!-- Modal Edit Proposal -->
    <div class="modal fade" id="modalEditProposal" tabindex="-1" aria-labelledby="modalEditProposalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditProposalLabel">Edit Proposal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditProposal">
                        <input type="hidden" name="proposal_id" id="edit_proposal_id">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Judul Usaha</label>
                                <input type="text" class="form-control" name="edit_judul_usaha" id="edit_judul_usaha" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kategori</label>
                                <select class="form-select" name="edit_kategori" id="edit_kategori" required>
                                    <option value="">Pilih Kategori</option>
                                    {% for kategori in [
                                        'Makanan dan Minuman', 'Budidaya', 'Industri Kreatif', 'Seni dan Budaya',
                                        'Jasa', 'Pariwisata dan Perdagangan', 'Manufaktur dan Teknologi Terapan', 'Bisnis Digital'
                                    ] %}
                                        <option value="{{ kategori }}">{{ kategori }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tahapan Usaha</label>
                                <select class="form-select" name="edit_tahapan_usaha" id="edit_tahapan_usaha" required>
                                    <option value="">Pilih Tahapan</option>
                                    <option value="Usaha Awal">Usaha Awal</option>
                                    <option value="Usaha Bertumbuh">Usaha Bertumbuh</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Merk/Nama Produk</label>
                                <input type="text" class="form-control" name="edit_merk_produk" id="edit_merk_produk" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">NIB (Nomor Induk Berusaha) <small class="text-muted">(Opsional)</small></label>
                                <input type="text" class="form-control" name="edit_nib" id="edit_nib">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tahun NIB <small class="text-muted">(Opsional)</small></label>
                                <input type="number" class="form-control" name="edit_tahun_nib" id="edit_tahun_nib" min="2000" max="2099">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Platform Penjualan</label>
                                <input type="text" class="form-control" name="edit_platform_penjualan" id="edit_platform_penjualan">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Upload Proposal</label>
                                <input type="file" class="form-control" name="edit_file_proposal" id="edit_file_proposal" accept=".pdf">
                                <small class="text-muted">Format: PDF (Max: 16MB)</small>
                            </div>
                            <div class="col-12">
                                <hr class="my-2">
                                <h6 class="mb-2" style="font-weight:700;">Dosen Pembimbing</h6>
                            </div>
                            <div class="row g-3 align-items-center">
                                <div class="col-md-4">
                                    <label class="form-label">Nama Dosen</label>
                                    <select class="form-select" name="edit_dosen_pembimbing" id="edit_dosen_pembimbing" required>
                                        <option value="">Pilih Dosen</option>
                                        {% for dosen in daftar_dosen %}
                                            <option value="{{ dosen.nama|e }}"
                                                data-nip="{{ dosen.nip|e }}"
                                                data-prodi="{{ dosen.program_studi|e }}"
                                                {% if dosen.status_kuota == 'penuh' %}disabled{% endif %}>
                                                {{ dosen.nama|e }}
                                                {% if dosen.status_kuota == 'penuh' %}
                                                    (Kuota Penuh)
                                                {% else %}
                                                    (Sisa: {% if dosen.sisa_kuota and dosen.sisa_kuota != 0 %}{{ dosen.sisa_kuota|e }}{% else %}-{% endif %})
                                                {% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">NID</label>
                                    <input type="text" class="form-control" name="edit_nid_dosen" id="edit_nid_dosen" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Program Studi</label>
                                    <input type="text" class="form-control" name="edit_program_studi_dosen" id="edit_program_studi_dosen" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
                <!-- Modal Pengajuan Proposal -->
    <div class="modal fade" id="modalPengajuan" tabindex="-1" aria-labelledby="modalPengajuanLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPengajuanLabel">Pengajuan Proposal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModalSafely(document.getElementById('modalPengajuan'))"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('mahasiswa.tambah_proposal') }}" method="POST" enctype="multipart/form-data">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Judul Usaha</label>
                                <input type="text" class="form-control" name="judul_usaha"
                                    placeholder="Masukkan Judul Usaha" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kategori</label>
                                <select class="form-select" name="kategori" required>
                                    <option value="">Pilih Kategori</option>
                                    <option value="Makanan dan Minuman">Makanan dan Minuman</option>
                                    <option value="Budidaya">Budidaya</option>
                                    <option value="Industri Kreatif">Industri Kreatif</option>
                                    <option value="Seni dan Budaya">Seni dan Budaya</option>
                                    <option value="Jasa">Jasa</option>
                                    <option value="Pariwisata dan Perdagangan">Pariwisata dan Perdagangan</option>
                                    <option value="Manufaktur dan Teknologi Terapan">Manufaktur dan Teknologi Terapan</option>
                                    <option value="Bisnis Digital">Bisnis Digital</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tahapan Usaha</label>
                                <select class="form-select" name="tahapan_usaha" required>
                                    <option value="">Pilih Tahapan</option>
                                    <option value="Usaha Awal">Usaha Awal</option>
                                    <option value="Usaha Bertumbuh">Usaha Bertumbuh</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Merk/Nama Produk</label>
                                <input type="text" class="form-control" name="merk_produk"
                                    placeholder="Masukkan Merk/Nama Produk" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">NIB (Nomor Induk Berusaha) <small class="text-muted">(Opsional)</small></label>
                                <input type="text" class="form-control" name="nib" placeholder="Masukkan NIB">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tahun NIB <small class="text-muted">(Opsional)</small></label>
                                <input type="number" class="form-control" name="tahun_nib" placeholder="Tahun"
                                    min="2000" max="2099">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Platform Penjualan</label>
                                <input type="text" class="form-control" name="platform_penjualan"
                                    placeholder="Shopee, Tokopedia, dll" >
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Upload Proposal</label>
                                <input type="file" class="form-control" name="file_proposal" accept=".pdf" 
                                    required>
                                <small class="text-muted">Format: PDF (Max: 16MB)</small>
                            </div>
                        </div>
                        <hr class="my-4">
                        <h6 class="mb-3">Dosen Pembimbing</h6>
                        <div class="row g-3 align-items-center">
                            <div class="col-md-4">
                                <label class="form-label">Nama Dosen</label>
                                <select class="form-select" name="dosen_pembimbing" id="dosen_pembimbing" required>
                                    <option value="">Pilih Dosen</option>
                                    {% for dosen in daftar_dosen %}
                                        <option value="{{ dosen.nama|e }}" 
                                                data-nip="{{ dosen.nip|e }}" 
                                                data-prodi="{{ dosen.program_studi|e }}"
                                                {% if dosen.status_kuota == 'penuh' %}disabled{% endif %}>
                                            {{ dosen.nama|e }} 
                                            {% if dosen.status_kuota == 'penuh' %}
                                                (Kuota Penuh)
                                            {% else %}
                                                (Sisa: {% if dosen.sisa_kuota and dosen.sisa_kuota != 0 %}{{ dosen.sisa_kuota|e }}{% else %}-{% endif %})
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">NID</label>
                                <input type="text" class="form-control" name="nid_dosen" id="nid_dosen" placeholder="NID Dosen" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Program Studi</label>
                                <input type="text" class="form-control" name="program_studi_dosen" id="program_studi_dosen" placeholder="Program Studi" readonly>
                            </div>
                        </div>
                        <small class="text-muted ms-1">
                            <i class="fas fa-info-circle"></i> Pilih dosen pembimbing yang masih memiliki kuota tersedia
                        </small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModalSafely(document.getElementById('modalPengajuan'))">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Tambah Anggota -->
    <div class="modal fade" id="modalTambahAnggota" tabindex="-1" aria-labelledby="modalTambahAnggotaLabel"
        aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
                    <h5 class="modal-title" id="modalTambahAnggotaLabel">Tambah Anggota Tim</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModalSafely(document.getElementById('modalTambahAnggota'))"></button>
          </div>
          <div class="modal-body">
                    <form action="{{ url_for('mahasiswa.tambah_anggota') }}" method="POST" id="formTambahAnggota">
                        <input type="hidden" name="id_proposal" id="id_proposal_anggota">

                        <!-- Container untuk semua form anggota -->
                        <div id="containerAnggota">
                            <!-- Card Anggota 1 -->
                            <div class="card anggota-card mb-3" data-anggota-id="1"
                                style="border-radius: 12px; border: 2px solid #e9ecef; transition: all 0.3s ease;">
                                <div class="card-header"
                                    style="background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; border-radius: 10px 10px 0 0; padding: 15px 20px;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-user-plus me-2"></i>
                                            Anggota 1
                                        </h6>
                                        <button type="button" class="btn btn-sm btn-outline-light btn-hapus-anggota"
                                            onclick="hapusAnggota(1)"
                                            style="display: none; border-radius: 50%; width: 28px; height: 28px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" style="padding: 20px;">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Perguruan Tinggi</label>
                                            <input type="text" class="form-control" name="perguruan_tinggi_1"
                                                value="Universitas Jenderal Achmad Yani Yogyakarta" readonly required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Program Studi</label>
                                            <select class="choices" name="program_studi_1" id="program_studi_1" required>
                                                <option value="">Pilih Program Studi</option>
                                                {% for prodi in program_studi_list %}
                                                    <option value="{{ prodi.nama_program_studi }}">{{ prodi.nama_program_studi }}</option>
                                                {% endfor %}
                                            </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">NIM</label>
                                            <input type="text" class="form-control" name="nim_1"
                                                placeholder="Masukkan NIM" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nama</label>
                                            <input type="text" class="form-control" name="nama_1"
                                                placeholder="Masukkan Nama" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Email</label>
                                            <input type="email" class="form-control" name="email_1"
                                                placeholder="Masukkan Email" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">No. Telpon</label>
                                            <input type="tel" class="form-control" name="no_telp_1"
                                                placeholder="Masukkan No. Telpon" required>
                </div>
              </div>
          </div>
                            </div>
                        </div>

                        <!-- Tombol Tambah Anggota -->
                        <div class="text-center mb-3">
                            <button type="button" class="btn btn-outline-success" onclick="tambahFormAnggota()"
                                style="border-radius: 25px; padding: 10px 25px;">
                                <i class="fas fa-plus me-2"></i>
                                Tambah Anggota
                            </button>
                        </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModalSafely(document.getElementById('modalTambahAnggota'))">Batal</button>
                            <button type="submit" class="btn btn-primary">Simpan Semua Anggota</button>
                        </div>
                    </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Lihat Detail Proposal -->
    <div class="modal fade" id="modalLihatProposal" tabindex="-1" aria-labelledby="modalLihatProposalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLihatProposalLabel">Detail Proposal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModalSafely(document.getElementById('modalLihatProposal'))"></button>
                </div>
                <div class="modal-body">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs" id="proposalTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab" aria-controls="detail" aria-selected="true">
                                <i class="fas fa-file-alt me-2"></i>Detail Proposal
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="anggota-tab" data-bs-toggle="tab" data-bs-target="#anggota" type="button" role="tab" aria-controls="anggota" aria-selected="false">
                                <i class="fas fa-users me-2"></i>Anggota Tim
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="proposalTabsContent">
                        <!-- Detail Proposal Tab -->
                        <div class="tab-pane fade show active" id="detail" role="tabpanel" aria-labelledby="detail-tab">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Judul Usaha</label>
                                        <p class="form-control-plaintext" id="detailJudulUsaha"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Kategori</label>
                                        <p class="form-control-plaintext" id="detailKategori"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Tahapan Usaha</label>
                                        <p class="form-control-plaintext" id="detailTahapanUsaha"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Merk Produk</label>
                                        <p class="form-control-plaintext" id="detailMerkProduk"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">NIB</label>
                                        <p class="form-control-plaintext" id="detailNIB"></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Tahun NIB</label>
                                        <p class="form-control-plaintext" id="detailTahunNIB"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Platform Penjualan</label>
                                        <p class="form-control-plaintext" id="detailPlatformPenjualan"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Dosen Pembimbing</label>
                                        <p class="form-control-plaintext" id="detailDosenPembimbing"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">NID Dosen</label>
                                        <p class="form-control-plaintext" id="detailNIDDosen"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Program Studi Dosen</label>
                                        <p class="form-control-plaintext" id="detailProgramStudiDosen"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">File Proposal & Status</label>
                                        <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                                <button type="button" id="detailFileProposalBtn" class="btn btn-outline-primary me-3" style="display: none;" 
                                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Klik untuk membuka file proposal di tab baru"
                                                        aria-label="Buka file proposal di tab baru">
                                                    <i class="fas fa-file-pdf me-2" aria-hidden="true"></i>
                                                Lihat File Proposal
                                                </button>
                                                <span id="detailFileProposalText" class="text-muted" role="status" aria-live="polite" tabindex="0">
                                                    <i class="fas fa-file-pdf me-2" aria-hidden="true"></i>
                                                    File proposal tidak tersedia
                                                </span>
                                        </div>
                                            <div class="d-flex align-items-center">
                                                <span class="badge fs-6 px-3 py-2" id="detailStatus" 
                                                      data-bs-toggle="tooltip" data-bs-placement="top" title="Status proposal saat ini"
                                                      role="status" aria-live="polite" tabindex="0"></span>
                                    </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Tanggal Buat Proposal</label>
                                                <p class="form-control-plaintext" id="detailTanggalBuat"></p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3" id="detailTanggalKirimContainer" style="display: none;">
                                                <label class="form-label fw-bold">Tanggal Kirim Proposal</label>
                                                <p class="form-control-plaintext" id="detailTanggalKirim"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Anggota Tim Tab -->
                        <div class="tab-pane fade" id="anggota" role="tabpanel" aria-labelledby="anggota-tab">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>No</th>
                                            <th>Perguruan Tinggi</th>
                                            <th>Program Studi</th>
                                            <th>NIM</th>
                                            <th>Nama</th>
                                            <th>Email</th>
                                            <th>No. Telpon</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailAnggotaTable">
                                        <!-- Data anggota akan diisi melalui JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noAnggotaMessage" class="text-center text-muted py-4" style="display: none;">
                                <i class="fas fa-users fa-3x mb-3"></i>
                                <p>Belum ada anggota tim yang ditambahkan</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModalSafely(document.getElementById('modalLihatProposal'))">Tutup</button>
                </div>
            </div>
        </div>
    </div>
            </div>


        </div>
    </div>
    <script src="{{ url_for('static', filename='assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js') }}">
    </script>
    <script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>

    <script src="{{ url_for('static', filename='assets/vendors/jquery/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/vendors/jquery-datatables/jquery.dataTables.min.js') }}">
    </script>
    <script
        src="{{ url_for('static', filename='assets/vendors/jquery-datatables/custom.jquery.dataTables.bootstrap5.min.js') }}">
    </script>
    <script src="{{ url_for('static', filename='assets/vendors/fontawesome/all.min.js') }}"></script>
    <!-- Choices.js -->
    <script src="{{ url_for('static', filename='assets/vendors/choices.js/choices.min.js') }}"></script>

    <script src="{{ url_for('static', filename='assets/js/mazer.js') }}"></script>


    <script>
        // Guard jadwal pengajuan proposal
        function parseDT(val){ return val ? new Date(val.replace('T',' ') + ':00') : null; }
        let jadwal = null;
        function within(dtStart, dtEnd, now){
            if (dtStart && now < dtStart) return {ok:false, reason:'belum_mulai'};
            if (dtEnd && now > dtEnd) return {ok:false, reason:'sudah_selesai'};
            return {ok:true};
        }
        function handleTambahUsulanKlik(){
            if (!jadwal) { bukaModalPengajuan(); return; }
            const now = new Date();
            const st = parseDT(jadwal.proposal_mulai);
            const en = parseDT(jadwal.proposal_selesai);
            const chk = within(st,en,now);
            if (!chk.ok){
                const mulaiText = st ? st.toLocaleString() : '-';
                const selesaiText = en ? en.toLocaleString() : '-';
                Swal.fire({
                    icon: 'info',
                    title: 'Di luar Jadwal Pengajuan',
                    html: `Jadwal pengajuan proposal dimulai pada <b>${mulaiText}</b> dan berakhir pada <b>${selesaiText}</b>.`,
                });
                return;
            }
            bukaModalPengajuan();
        }
        // Fungsi untuk membuka modal pengajuan proposal
        function bukaModalPengajuan() {
            const modal = ensureModalClosable('modalPengajuan');
            if (modal) {
                modal.show();
            }
        }

        // Fungsi untuk menutup modal dengan aman
        function closeModalSafely(modalElement) {
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }
        }
        
        // Fungsi untuk memastikan modal bisa ditutup dengan benar
        function ensureModalClosable(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.setAttribute('data-bs-backdrop', 'true');
                modalElement.setAttribute('data-bs-keyboard', 'true');
                return new bootstrap.Modal(modalElement, {
                    backdrop: true,
                    keyboard: true
                });
            }
            return null;
        }

        // Event listener untuk DOM content loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Ambil pengaturan jadwal
            $.get('{{ url_for("mahasiswa.get_pengaturan_jadwal_mhs") }}').done(function(resp){
                if (resp && resp.success) {
                    jadwal = resp.data || null;
                }
            });
            // Event listener untuk dosen pembimbing
            const dosenSelect = document.getElementById('dosen_pembimbing');
            const nidInput = document.getElementById('nid_dosen');
            const prodiInput = document.getElementById('program_studi_dosen');

            if (dosenSelect) {
                dosenSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption && selectedOption.dataset.nip) {
                        nidInput.value = selectedOption.dataset.nip;
                        prodiInput.value = selectedOption.dataset.prodi;
                    } else {
                        nidInput.value = '';
                        prodiInput.value = '';
                    }
                });
            }
            
            // Inisialisasi Choices.js untuk dropdown program studi pertama
            const programStudiSelect = document.getElementById('program_studi_1');
            if (programStudiSelect) {
                const choices = new Choices(programStudiSelect, {
                    searchEnabled: true,
                    searchPlaceholderValue: 'Ketik untuk mencari program studi...',
                    placeholder: true,
                    placeholderValue: 'Pilih Program Studi',
                    removeItemButton: false,
                    shouldSort: true,
                    position: 'bottom',
                    maxItemCount: 1,
                    searchResultLimit: 10,
                    searchFields: ['label', 'value'],
                    classNames: {
                        containerOuter: 'choices',
                        containerInner: 'choices__inner',
                        input: 'choices__input',
                        inputCloned: 'choices__input--cloned',
                        list: 'choices__list',
                        listItems: 'choices__list--multiple',
                        listSingle: 'choices__list--single',
                        listDropdown: 'choices__list--dropdown',
                        item: 'choices__item',
                        placeholder: 'choices__placeholder',
                        group: 'choices__group',
                        groupHeading: 'choices__heading',
                        label: 'choices__label',
                        activeState: 'is-active',
                        focusState: 'is-focused',
                        openState: 'is-open',
                        disabledState: 'is-disabled',
                        flippedState: 'is-flipped',
                        loadingState: 'is-loading',
                        noResults: 'has-no-results',
                        noChoices: 'has-no-choices'
                    }
                });
                
                // Memastikan dropdown pertama memiliki styling yang sama
                setTimeout(() => {
                    const choicesContainer = document.querySelector('#program_studi_1').closest('.choices');
                    const choicesInner = document.querySelector('#program_studi_1').closest('.choices__inner');
                    if (choicesContainer && choicesInner) {
                        choicesContainer.style.width = '100%';
                        choicesInner.style.width = '100%';
                        choicesInner.style.height = '38px';
                        choicesInner.style.minHeight = '38px';
                        choicesInner.style.padding = '0.375rem 0.75rem';
                        choicesInner.style.fontSize = '1rem';
                        choicesInner.style.lineHeight = '1.5';
                        choicesInner.style.borderRadius = '0.5rem';
                        choicesInner.style.border = '1px solid #d1d5db';
                        choicesInner.style.boxSizing = 'border-box';
                        choicesInner.style.display = 'flex';
                        choicesInner.style.alignItems = 'center';
                    }
                }, 100);
                
                // Event listener untuk dropdown pertama (hanya jika choices memiliki method on)
                if (choices && typeof choices.on === 'function') {
                    choices.on('showDropdown', function() {
                        console.log('Dropdown program studi dibuka');
                    });
                    
                    choices.on('hideDropdown', function() {
                        console.log('Dropdown program studi ditutup');
                    });
                }
            }
        });

        // Fungsi helper untuk format tanggal
        function formatTanggalIndonesia(dateString) {
            if (!dateString || dateString === 'None' || dateString === '') return '-';
            
            try {
                // Parse tanggal dari format database (YYYY-MM-DD HH:MM:SS)
                // Gunakan UTC untuk menghindari masalah timezone
                const tanggal = new Date(dateString + 'Z'); // Tambahkan Z untuk UTC
                if (!isNaN(tanggal.getTime())) {
                    // Format manual untuk konsistensi
                    const tahun = tanggal.getUTCFullYear();
                    const bulan = tanggal.getUTCMonth();
                    const tanggal_hari = tanggal.getUTCDate();
                    const jam = tanggal.getUTCHours().toString().padStart(2, '0');
                    const menit = tanggal.getUTCMinutes().toString().padStart(2, '0');
                    const detik = tanggal.getUTCSeconds().toString().padStart(2, '0');
                    
                    // Array nama bulan dalam bahasa Indonesia
                    const namaBulan = [
                        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
                    ];
                    
                    return `${tanggal_hari} ${namaBulan[bulan]} ${tahun} pukul ${jam}.${menit}.${detik}`;
                } else {
                    // Fallback: coba parse manual dari string
                    console.log('Debug - Fallback parsing untuk:', dateString);
                    return parseTanggalManual(dateString);
                }
            } catch (error) {
                console.log('Debug - Error parsing tanggal:', error);
                // Fallback: coba parse manual dari string
                return parseTanggalManual(dateString);
            }
        }
        
        // Fungsi fallback untuk parse tanggal manual
        function parseTanggalManual(dateString) {
            try {
                // Format: YYYY-MM-DD HH:MM:SS
                const match = dateString.match(/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/);
                if (match) {
                    const [, tahun, bulan, tanggal, jam, menit, detik] = match;
                    const namaBulan = [
                        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
                    ];
                    
                    return `${parseInt(tanggal)} ${namaBulan[parseInt(bulan) - 1]} ${tahun} pukul ${jam}.${menit}.${detik}`;
                }
                return dateString; // Return format asli jika tidak match
            } catch (error) {
                console.log('Debug - Error parse manual:', error);
                return dateString;
            }
        }

        // Fungsi untuk melihat detail proposal
        function lihatProposal(proposalId) {
            // Tampilkan loading
            Swal.fire({
                title: 'Memuat Detail Proposal...',
                text: 'Mohon tunggu sebentar',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Ambil data detail proposal dari endpoint
            fetch(`/mahasiswa/get_proposal_detail/${proposalId}`)
                .then(response => response.json())
                .then(data => {
                    Swal.close();
                    
                    if (data.success) {
                        // Isi data proposal ke modal
                        const proposal = data.proposal;
                        const anggota = data.anggota;
                        

                        
                        // Isi detail proposal
                        document.getElementById('detailJudulUsaha').textContent = proposal.judul_usaha || '-';
                        document.getElementById('detailKategori').textContent = proposal.kategori || '-';
                        document.getElementById('detailTahapanUsaha').textContent = proposal.tahapan_usaha || '-';
                        document.getElementById('detailMerkProduk').textContent = proposal.merk_produk || '-';
                        document.getElementById('detailNIB').textContent = proposal.nib || '-';
                        document.getElementById('detailTahunNIB').textContent = proposal.tahun_nib || '-';
                        document.getElementById('detailPlatformPenjualan').textContent = proposal.platform_penjualan || '-';
                        document.getElementById('detailDosenPembimbing').textContent = proposal.dosen_pembimbing || '-';
                        document.getElementById('detailNIDDosen').textContent = proposal.nid_dosen || '-';
                        document.getElementById('detailProgramStudiDosen').textContent = proposal.program_studi_dosen || '-';
                        
                        // Set tanggal buat proposal
                        const tanggalBuatElement = document.getElementById('detailTanggalBuat');
                        if (proposal.tanggal_buat && proposal.tanggal_buat !== 'None' && proposal.tanggal_buat !== '') {
                            const tanggalBuatFormatted = formatTanggalIndonesia(proposal.tanggal_buat);
                            console.log('Debug - Tanggal buat formatted:', tanggalBuatFormatted);
                            tanggalBuatElement.textContent = tanggalBuatFormatted;
                        } else {
                            tanggalBuatElement.textContent = '-';
                        }
                        
                        // Set file proposal button
                        const fileBtn = document.getElementById('detailFileProposalBtn');
                        const fileText = document.getElementById('detailFileProposalText');
                        if (proposal.file_path) {
                            fileBtn.style.display = 'inline-block';
                            fileText.style.display = 'none';
                            fileBtn.onclick = function(e) {
                                handleFileProposalClick(e);
                            };
                            
                            fileBtn.onkeydown = function(e) {
                                if (e.key === 'Enter' || e.key === ' ') {
                                    e.preventDefault();
                                    handleFileProposalClick(e);
                                }
                            };
                            
                            function handleFileProposalClick(e) {
                                // Efek ripple
                                const ripple = document.createElement('span');
                                const rect = fileBtn.getBoundingClientRect();
                                const size = Math.max(rect.width, rect.height);
                                const x = e.clientX - rect.left - size / 2;
                                const y = e.clientY - rect.top - size / 2;
                                
                                ripple.style.width = ripple.style.height = size + 'px';
                                ripple.style.left = x + 'px';
                                ripple.style.top = y + 'px';
                                ripple.classList.add('ripple');
                                fileBtn.appendChild(ripple);
                                
                                setTimeout(() => ripple.remove(), 600);
                                
                                // Tampilkan loading state
                                const originalText = fileBtn.innerHTML;
                                fileBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2" style="color: #fff;"></i>Membuka File<span class="loading-dots">...</span>';
                                fileBtn.disabled = true;
                                fileBtn.style.background = 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
                                fileBtn.style.borderColor = '#6c757d';
                                fileBtn.style.position = 'relative';
                                fileBtn.style.overflow = 'hidden';
                                
                                // Tambahkan progress bar
                                const progressBar = document.createElement('div');
                                progressBar.style.position = 'absolute';
                                progressBar.style.bottom = '0';
                                progressBar.style.left = '0';
                                progressBar.style.height = '3px';
                                progressBar.style.background = 'linear-gradient(90deg, #28a745, #20c997, #17a2b8)';
                                progressBar.style.width = '0%';
                                progressBar.style.transition = 'width 2s linear';
                                progressBar.style.borderRadius = '0 0 8px 8px';
                                progressBar.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';
                                fileBtn.appendChild(progressBar);
                                
                                // Animate progress bar
                                setTimeout(() => {
                                    progressBar.style.width = '100%';
                                }, 100);
                                
                                // Buka file di tab baru
                                const downloadWindow = window.open(`/mahasiswa/download_proposal/${proposal.id}`, '_blank');
                                
                                // Kembalikan tombol setelah 2 detik
                                setTimeout(() => {
                                    // Tampilkan checkmark terlebih dahulu
                                    fileBtn.innerHTML = '<i class="fas fa-check me-2" style="color: #fff;"></i>Berhasil!';
                                    fileBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                                    fileBtn.style.borderColor = '#28a745';
                                    
                                    // Kembalikan ke tampilan normal setelah 1 detik
                                    setTimeout(() => {
                                                                                fileBtn.innerHTML = originalText;
                                        fileBtn.disabled = false;
                                        fileBtn.style.background = 'linear-gradient(135deg, #435ebe 0%, #5a6fd8 100%)';
                                        fileBtn.style.borderColor = '#435ebe';
                                        fileBtn.style.position = '';
                                        fileBtn.style.overflow = '';
                                        
                                        // Hapus progress bar
                                        const progressBar = fileBtn.querySelector('div');
                                        if (progressBar) {
                                            progressBar.remove();
                                        }
                                    }, 1000);
                                    
                                    // Efek suara sederhana (opsional)
                                    try {
                                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                                        const oscillator = audioContext.createOscillator();
                                        const gainNode = audioContext.createGain();
                                        
                                        oscillator.connect(gainNode);
                                        gainNode.connect(audioContext.destination);
                                        
                                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                                        oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                                        
                                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                                        
                                        oscillator.start(audioContext.currentTime);
                                        oscillator.stop(audioContext.currentTime + 0.1);
                                    } catch (e) {
                                        // Ignore jika audio tidak didukung
                                    }
                                    
                                    // Efek vibrasi untuk mobile (jika didukung)
                                    if ('vibrate' in navigator) {
                                        navigator.vibrate([100, 50, 100]);
                                    }
                                    
                                    // Efek konfetti sederhana
                                    const colors = ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6f42c1'];
                                    for (let i = 0; i < 10; i++) {
                                        setTimeout(() => {
                                            const confetti = document.createElement('div');
                                            confetti.style.position = 'fixed';
                                            confetti.style.left = Math.random() * window.innerWidth + 'px';
                                            confetti.style.top = '-10px';
                                            confetti.style.width = '8px';
                                            confetti.style.height = '8px';
                                            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                                            confetti.style.borderRadius = '50%';
                                            confetti.style.pointerEvents = 'none';
                                            confetti.style.zIndex = '9999';
                                            confetti.style.animation = 'confetti-fall 2s linear forwards';
                                            document.body.appendChild(confetti);
                                            
                                            setTimeout(() => confetti.remove(), 2000);
                                        }, i * 100);
                                    }
                                    
                                    // Tampilkan pesan sukses
                                    if (typeof Toastify !== 'undefined') {
                                        Toastify({
                                            text: "File proposal berhasil dibuka di tab baru!",
                                            duration: 3000,
                                            gravity: "top",
                                            position: "right",
                                            backgroundColor: "#28a745",
                                            stopOnFocus: true,
                                            close: true,
                                            style: {
                                                background: "linear-gradient(135deg, #28a745 0%, #20c997 100%)",
                                                borderRadius: "8px",
                                                boxShadow: "0 4px 12px rgba(40, 167, 69, 0.3)"
                                            }
                                        }).showToast();
                                    } else {
                                        // Fallback dengan SweetAlert jika Toastify tidak tersedia
                                        Swal.fire({
                                            title: 'Berhasil!',
                                            text: 'File proposal berhasil dibuka di tab baru!',
                                            icon: 'success',
                                            timer: 2000,
                                            showConfirmButton: false,
                                            toast: true,
                                            position: 'top-end'
                                        });
                                    }
                                }, 2000);
                            };
                        } else {
                            fileBtn.style.display = 'none';
                            fileText.style.display = 'inline';
                            
                            // Tambahkan keyboard support untuk pesan file tidak tersedia
                            fileText.onkeydown = function(e) {
                                if (e.key === 'Enter' || e.key === ' ') {
                                    e.preventDefault();
                                    Swal.fire({
                                        title: 'File Tidak Tersedia',
                                        text: 'File proposal belum diupload atau tidak tersedia.',
                                        icon: 'warning',
                                        confirmButtonColor: '#3085d6',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            };
                        }
                        
                        // Set status dengan badge yang sesuai
                        const statusElement = document.getElementById('detailStatus');
                        const status = proposal.status || 'draf';
                        statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                        
                        // Tambahkan keyboard support untuk badge status
                        statusElement.onkeydown = function(e) {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                // Tampilkan informasi status yang lebih detail
                                Swal.fire({
                                    title: 'Status Proposal',
                                    text: `Status proposal saat ini: ${status.charAt(0).toUpperCase() + status.slice(1)}`,
                                    icon: 'info',
                                    confirmButtonColor: '#3085d6',
                                    confirmButtonText: 'OK'
                                });
                            }
                        };
                        
                        // Set warna badge berdasarkan status
                        statusElement.className = 'badge';
                        switch (status) {
                            case 'draf':
                                statusElement.classList.add('bg-secondary');
                                break;
                            case 'diajukan':
                                statusElement.classList.add('bg-primary');
                                break;
                            case 'disetujui':
                                statusElement.classList.add('bg-success');
                                break;
                            case 'lolos':
                                statusElement.classList.add('bg-info');
                                break;
                            case 'tolak':
                                statusElement.classList.add('bg-danger');
                                break;
                            default:
                                statusElement.classList.add('bg-secondary');
                        }
                        
                        // Set tanggal kirim dengan format yang sesuai database
                        const tanggalKirimContainer = document.getElementById('detailTanggalKirimContainer');
                        const tanggalKirimElement = document.getElementById('detailTanggalKirim');
                        
                        // Debug: log data tanggal dari database
                        console.log('Debug - Data proposal dari database:', {
                            status: proposal.status,
                            tanggal_kirim: proposal.tanggal_kirim,
                            tanggal_buat: proposal.tanggal_buat
                        });
                        
                        // Tampilkan tanggal kirim jika proposal sudah dikirim (bukan draf)
                        if (proposal.status !== 'draf' && proposal.tanggal_kirim && proposal.tanggal_kirim !== 'None' && proposal.tanggal_kirim !== '') {
                            // Format tanggal menggunakan fungsi helper
                            const tanggalFormatted = formatTanggalIndonesia(proposal.tanggal_kirim);
                            console.log('Debug - Tanggal kirim formatted:', tanggalFormatted);
                            tanggalKirimElement.textContent = tanggalFormatted;
                            tanggalKirimContainer.style.display = 'block';
                        } else if (proposal.status === 'draf') {
                            // Jika proposal masih draf
                            tanggalKirimElement.textContent = 'Proposal belum dikirim';
                            tanggalKirimContainer.style.display = 'block';
                        } else {
                            // Jika tidak ada tanggal kirim
                            tanggalKirimContainer.style.display = 'none';
                        }
                        
                        // Isi data anggota tim
                        const anggotaTable = document.getElementById('detailAnggotaTable');
                        const noAnggotaMessage = document.getElementById('noAnggotaMessage');
                        
                        if (anggota && anggota.length > 0) {
                            anggotaTable.innerHTML = '';
                            anggota.forEach((member, index) => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${index + 1}</td>
                                    <td>${member.perguruan_tinggi || '-'}</td>
                                    <td>${member.program_studi || '-'}</td>
                                    <td>${member.nim || '-'}</td>
                                    <td>${member.nama || '-'}</td>
                                    <td>${member.email || '-'}</td>
                                    <td>${member.no_telp || '-'}</td>
                                `;
                                anggotaTable.appendChild(row);
                            });
                            anggotaTable.style.display = 'table-row-group';
                            noAnggotaMessage.style.display = 'none';
                        } else {
                            anggotaTable.style.display = 'none';
                            noAnggotaMessage.style.display = 'block';
                        }
                        
                        // Tampilkan modal
                        const modal = ensureModalClosable('modalLihatProposal');
                        if (modal) {
                            modal.show();
                            
                                                    // Inisialisasi tooltip untuk tombol file proposal dan badge status
                        initializeTooltips();
                        }
                    } else {
                        Swal.fire({
                            title: 'Gagal Memuat Data',
                            text: data.message || 'Terjadi kesalahan saat memuat detail proposal',
                            icon: 'error',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => {
                    Swal.close();
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Terjadi kesalahan saat memuat detail proposal',
                        icon: 'error',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'OK'
                    });
                });
        }

        // Fungsi untuk menambah anggota
        function tambahAnggota(proposalId, jumlahAnggotaExisting) {
            // Cek apakah sudah mencapai batas maksimal
            if (jumlahAnggotaExisting >= 4) {
                Swal.fire({
                    title: 'Anggota Tim Maksimal',
                    text: 'Tim Anda sudah mencapai batas maksimal 4 anggota!',
                    icon: 'warning',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            // Tampilkan informasi tentang jumlah minimal dan maksimal
            if (jumlahAnggotaExisting < 3) {
                Swal.fire({
                    title: 'Informasi Jumlah Anggota',
                    html: `
                        <div class="text-start">
                            <p><strong>Tim harus memiliki minimal 3 anggota dan maksimal 4 anggota.</strong></p>
                            <p>Saat ini tim Anda memiliki <strong>${jumlahAnggotaExisting} anggota</strong>.</p>
                            <p>Anda perlu menambahkan minimal <strong>${3 - jumlahAnggotaExisting} anggota lagi</strong> sebelum dapat mengirim proposal.</p>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'Mengerti'
                });
            }
            
            document.getElementById('id_proposal_anggota').value = proposalId;
            // Simpan jumlah anggota existing untuk digunakan di form
            const modalElement = document.getElementById('modalTambahAnggota');
            modalElement.setAttribute('data-existing-count', jumlahAnggotaExisting);
            const modal = ensureModalClosable('modalTambahAnggota');
            if (modal) {
                modal.show();
            }
            
            // Inisialisasi tombol "Tambah Anggota" saat modal dibuka
            setTimeout(() => {
                cekTombolTambahAnggota();
                // Update informasi jumlah anggota existing
                const infoAnggota = document.getElementById('infoAnggota');
                const spanAnggota = document.getElementById('jumlahAnggotaExisting');
                if (infoAnggota && spanAnggota) {
                    spanAnggota.textContent = jumlahAnggotaExisting;
                } else {
                    // Jika elemen belum ada, buat informasi di JavaScript
                    const modalBody = document.querySelector('#modalTambahAnggota .modal-body');
                    if (modalBody) {
                        const existingInfo = modalBody.querySelector('#infoAnggota');
                        if (!existingInfo) {
                            const infoDiv = document.createElement('div');
                            infoDiv.className = 'alert alert-info mb-3';
                            infoDiv.id = 'infoAnggota';
                            let statusMessage = '';
                            if (jumlahAnggotaExisting < 3) {
                                statusMessage = `<br><span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Anda perlu menambahkan minimal ${3 - jumlahAnggotaExisting} anggota lagi sebelum dapat mengirim proposal.</span>`;
                            } else if (jumlahAnggotaExisting >= 3 && jumlahAnggotaExisting < 4) {
                                statusMessage = `<br><span class="text-success"><i class="fas fa-check-circle me-1"></i>Tim sudah memenuhi syarat minimal 3 anggota. Anda dapat menambahkan ${4 - jumlahAnggotaExisting} anggota lagi.</span>`;
                            } else {
                                statusMessage = `<br><span class="text-success"><i class="fas fa-check-circle me-1"></i>Tim sudah lengkap dengan 4 anggota.</span>`;
                            }
                            
                            infoDiv.innerHTML = `
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Informasi:</strong> Tim harus memiliki minimal 3 anggota dan maksimal 4 anggota. Saat ini sudah ada <span id="jumlahAnggotaExisting">${jumlahAnggotaExisting}</span> anggota.
                                ${statusMessage}
                            `;
                            const form = modalBody.querySelector('form');
                            if (form) {
                                form.insertBefore(infoDiv, form.firstChild);
                            }
                        }
                    }
                }
            }, 100);
        }

        // Fungsi untuk ke halaman anggaran
        function keAnggaran(proposalId, tahapanUsaha) {
            console.log('Redirecting to anggaran:', { proposalId, tahapanUsaha });
            
            // Validasi parameter
            if (!proposalId) {
                Swal.fire({
                    title: 'ID Proposal Tidak Valid',
                    text: 'ID Proposal tidak ditemukan. Silakan coba lagi.',
                    icon: 'error',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            if (!tahapanUsaha) {
                Swal.fire({
                    title: 'Tahapan Usaha Tidak Ditemukan',
                    text: 'Tahapan usaha tidak ditemukan. Silakan hubungi admin.',
                    icon: 'error',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            // Tampilkan loading
            Swal.fire({
                title: 'Memuat Halaman Anggaran...',
                text: 'Mohon tunggu sebentar',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Redirect ke halaman anggaran berdasarkan tahapan usaha
            if (tahapanUsaha === 'Usaha Awal') {
                console.log('Redirecting to anggaran awal');
                const url = `/mahasiswa/pengajuan_anggaran_awal_mahasiswa?proposal_id=${proposalId}`;
                console.log('URL:', url);
                window.location.href = url;
            } else if (tahapanUsaha === 'Usaha Bertumbuh') {
                console.log('Redirecting to anggaran bertumbuh');
                const url = `/mahasiswa/pengajuan_anggaran_bertumbuh_mahasiswa?proposal_id=${proposalId}`;
                console.log('URL:', url);
                window.location.href = url;
            } else {
                // Fallback jika tahapan tidak dikenali
                console.error('Tahapan usaha tidak dikenali:', tahapanUsaha);
                Swal.close();
                Swal.fire({
                    title: 'Tahapan Usaha Tidak Dikenali',
                    text: `Tahapan usaha "${tahapanUsaha}" tidak valid. Silakan hubungi admin.`,
                    icon: 'error',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
            }
        }

        // Fungsi untuk hapus proposal
        function hapusProposal(proposalId) {
            Swal.fire({
                title: 'Konfirmasi Hapus',
                text: 'Apakah Anda yakin ingin menghapus proposal ini? Semua data terkait akan dihapus secara permanen!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Tampilkan loading
                    Swal.fire({
                        title: 'Menghapus Proposal...',
                        text: 'Mohon tunggu sebentar',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Kirim request ke endpoint Flask
                    fetch(`/mahasiswa/hapus_proposal/${proposalId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (response.redirected) {
                            // Jika ada redirect, reload halaman
                            window.location.reload();
                        } else {
                            return response.text();
                        }
                    })
                    .then(data => {
                        // Reload halaman untuk menampilkan flash message
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error!',
                            text: 'Terjadi kesalahan saat menghapus proposal',
                            icon: 'error',
                            confirmButtonColor: '#3085d6'
                        });
                    });
                }
            });
        }

        // Fungsi untuk kirim proposal
        function kirimProposal(proposalId) {
            // Cek apakah proposal sudah punya dosen pembimbing
            const row = document.querySelector(`tr[data-proposal-id="${proposalId}"]`);
            let dosenPembimbing = null;
            if (row) {
                dosenPembimbing = row.getAttribute('data-dosen-pembimbing');
            }
            if (!dosenPembimbing || dosenPembimbing === '-' || dosenPembimbing === '' || dosenPembimbing === null) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Dosen Pembimbing Belum Dipilih',
                    text: 'Anda harus memilih dosen pembimbing terlebih dahulu sebelum mengirim proposal. Silakan edit proposal dan pilih dosen pembimbing.',
                    confirmButtonText: 'Mengerti',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }
            
            // Cek jumlah anggota tim minimal 3
            const jumlahAnggotaElement = document.querySelector(`tr[data-proposal-id="${proposalId}"] .btn-circle[title*="Tambah Anggota"]`);
            if (jumlahAnggotaElement) {
                const titleText = jumlahAnggotaElement.getAttribute('title');
                const match = titleText.match(/\((\d+)\/4\)/);
                if (match) {
                    const jumlahAnggota = parseInt(match[1]);
                    if (jumlahAnggota < 3) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Jumlah Anggota Tim Tidak Mencukupi',
                            text: `Tim harus memiliki minimal 3 anggota sebelum mengirim proposal. Saat ini hanya ada ${jumlahAnggota} anggota. Silakan tambahkan anggota tim terlebih dahulu.`,
                            confirmButtonText: 'Mengerti',
                            confirmButtonColor: '#3085d6'
                        });
                        return;
                    }
                }
            }
            Swal.fire({
                title: 'Konfirmasi Kirim',
                text: 'Apakah Anda yakin ingin mengirim proposal ini? Proposal akan dikirim ke pembimbing untuk review.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Ya, Kirim!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Tampilkan loading
                    Swal.fire({
                        title: 'Mengirim Proposal...',
                        text: 'Mohon tunggu sebentar',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Kirim request ke endpoint Flask
                    fetch(`/mahasiswa/kirim_proposal/${proposalId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        }
                    })
                    .then(async (response) => {
                        let payload = null;
                        try { payload = await response.json(); } catch (_) {}
                        if (!response.ok || !payload || payload.success === false) {
                            const msg = (payload && payload.message) ? payload.message : 'Terjadi kesalahan saat mengirim proposal';
                            throw new Error(msg);
                        }
                        return payload;
                    })
                    .then((payload) => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil',
                            text: payload.message || 'Proposal berhasil dikirim!',
                            confirmButtonColor: '#3085d6'
                        }).then(() => {
                            window.location.reload();
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error!',
                            text: error.message || 'Terjadi kesalahan saat mengirim proposal',
                            icon: 'error',
                            confirmButtonColor: '#3085d6'
                        });
                    });
                }
            });
        }

        // Fungsi untuk menambah form anggota
        function tambahFormAnggota() {
            const container = document.getElementById('containerAnggota');
            const anggotaCards = container.querySelectorAll('.anggota-card');
            const modal = document.getElementById('modalTambahAnggota');
            const existingCount = parseInt(modal.getAttribute('data-existing-count') || 0);
            const totalAnggota = existingCount + anggotaCards.length;
            
            // Cek apakah sudah mencapai batas maksimal 4 anggota
            if (totalAnggota >= 4) {
                Swal.fire({
                    title: 'Anggota Tim Maksimal',
                    text: `Total anggota tim maksimal 4 orang. Saat ini sudah ${totalAnggota} anggota.`,
                    icon: 'warning',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
                return;
            }
            const newId = anggotaCards.length + 1;
            const newCard = document.createElement('div');
            newCard.className = 'card anggota-card mb-3';
            newCard.setAttribute('data-anggota-id', newId);
            newCard.style.cssText = 'border-radius: 12px; border: 2px solid #e9ecef; transition: all 0.3s ease;';
            newCard.innerHTML = `
                <div class="card-header" style="background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; border-radius: 10px 10px 0 0; padding: 15px 20px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-user-plus me-2"></i>
                            Anggota ${newId}
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-light btn-hapus-anggota" onclick="hapusAnggota(${newId})" style="border-radius: 50%; width: 28px; height: 28px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding: 20px;">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Perguruan Tinggi</label>
                            <input type="text" class="form-control" name="perguruan_tinggi_${newId}" value="Universitas Jenderal Achmad Yani Yogyakarta" readonly required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Program Studi</label>
                            <select class="choices" name="program_studi_${newId}" id="program_studi_${newId}" required>
                                <option value="">Pilih Program Studi</option>
                                {% for prodi in program_studi_list %}
                                    <option value="{{ prodi.nama_program_studi }}">{{ prodi.nama_program_studi }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">NIM</label>
                            <input type="text" class="form-control" name="nim_${newId}" placeholder="Masukkan NIM" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nama</label>
                            <input type="text" class="form-control" name="nama_${newId}" placeholder="Masukkan Nama" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email_${newId}" placeholder="Masukkan Email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">No. Telpon</label>
                            <input type="tel" class="form-control" name="no_telp_${newId}" placeholder="Masukkan No. Telpon" required>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(newCard);
            
            // Inisialisasi Choices.js untuk dropdown program studi yang baru dibuat
            const newSelect = newCard.querySelector(`#program_studi_${newId}`);
            if (newSelect) {
                const choices = new Choices(newSelect, {
                    searchEnabled: true,
                    searchPlaceholderValue: 'Ketik untuk mencari program studi...',
                    placeholder: true,
                    placeholderValue: 'Pilih Program Studi',
                    removeItemButton: false,
                    shouldSort: true,
                    position: 'bottom',
                    maxItemCount: 1,
                    searchResultLimit: 10,
                    searchFields: ['label', 'value'],
                    classNames: {
                        containerOuter: 'choices',
                        containerInner: 'choices__inner',
                        input: 'choices__input',
                        inputCloned: 'choices__input--cloned',
                        list: 'choices__list',
                        listItems: 'choices__list--multiple',
                        listSingle: 'choices__list--single',
                        listDropdown: 'choices__list--dropdown',
                        item: 'choices__item',
                        placeholder: 'choices__placeholder',
                        group: 'choices__group',
                        groupHeading: 'choices__heading',
                        label: 'choices__label',
                        activeState: 'is-active',
                        focusState: 'is-focused',
                        openState: 'is-open',
                        disabledState: 'is-disabled',
                        flippedState: 'is-flipped',
                        loadingState: 'is-loading',
                        noResults: 'has-no-results',
                        noChoices: 'has-no-choices'
                    }
                });
                
                // Memastikan dropdown yang baru dibuat memiliki styling yang sama
                setTimeout(() => {
                    const choicesContainer = newCard.querySelector('.choices');
                    const choicesInner = newCard.querySelector('.choices__inner');
                    if (choicesContainer && choicesInner) {
                        choicesContainer.style.width = '100%';
                        choicesInner.style.width = '100%';
                        choicesInner.style.height = '38px';
                        choicesInner.style.minHeight = '38px';
                        choicesInner.style.padding = '0.375rem 0.75rem';
                        choicesInner.style.fontSize = '1rem';
                        choicesInner.style.lineHeight = '1.5';
                        choicesInner.style.borderRadius = '0.5rem';
                        choicesInner.style.border = '1px solid #d1d5db';
                        choicesInner.style.boxSizing = 'border-box';
                        choicesInner.style.display = 'flex';
                        choicesInner.style.alignItems = 'center';
                    }
                }, 100);
                
                // Event listener untuk dropdown yang baru dibuat (hanya jika choices memiliki method on)
                if (choices && typeof choices.on === 'function') {
                    choices.on('showDropdown', function() {
                        console.log(`Dropdown program studi anggota ${newId} dibuka`);
                    });
                    
                    choices.on('hideDropdown', function() {
                        console.log(`Dropdown program studi anggota ${newId} ditutup`);
                    });
                }
            }
            
            // Tampilkan tombol hapus untuk semua anggota kecuali yang pertama
            const allCards = container.querySelectorAll('.anggota-card');
            allCards.forEach((card, index) => {
                const hapusBtn = card.querySelector('.btn-hapus-anggota');
                if (hapusBtn) {
                    hapusBtn.style.display = index === 0 ? 'none' : 'flex';
                }
            });
            // Cek dan update tombol "Tambah Anggota"
            cekTombolTambahAnggota();
        }
        
        // Fungsi untuk mengecek dan mengatur tombol "Tambah Anggota"
        function cekTombolTambahAnggota() {
            const container = document.getElementById('containerAnggota');
            const anggotaCards = container.querySelectorAll('.anggota-card');
            const modal = document.getElementById('modalTambahAnggota');
            const existingCount = parseInt(modal.getAttribute('data-existing-count') || 0);
            const totalAnggota = existingCount + anggotaCards.length;
            
            const btnTambahAnggota = document.querySelector('.btn-outline-success');
            if (btnTambahAnggota) {
                if (totalAnggota >= 4) {
                    btnTambahAnggota.style.display = 'none';
                } else {
                    btnTambahAnggota.style.display = '';
                    // Update teks tombol untuk menunjukkan sisa slot dan status minimal
                    const sisaSlot = 4 - totalAnggota;
                    const statusMinimal = totalAnggota < 3 ? ' (Minimal 3)' : '';
                    btnTambahAnggota.innerHTML = `<i class="fas fa-plus me-2"></i>Tambah Anggota (${sisaSlot} slot tersisa${statusMinimal})`;
                    
                    // Tambahkan warna warning jika belum mencapai minimal
                    if (totalAnggota < 3) {
                        btnTambahAnggota.classList.add('btn-warning');
                        btnTambahAnggota.classList.remove('btn-outline-success');
                    } else {
                        btnTambahAnggota.classList.remove('btn-warning');
                        btnTambahAnggota.classList.add('btn-outline-success');
                    }
                }
            }
            
            // Update informasi di modal jika ada
            const infoAnggota = document.getElementById('infoAnggota');
            if (infoAnggota) {
                const spanAnggota = infoAnggota.querySelector('#jumlahAnggotaExisting');
                if (spanAnggota) {
                    spanAnggota.textContent = totalAnggota;
                }
                
                // Update pesan informasi
                let statusMessage = '';
                if (totalAnggota < 3) {
                    statusMessage = `<br><span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Anda perlu menambahkan minimal ${3 - totalAnggota} anggota lagi sebelum dapat mengirim proposal.</span>`;
                } else if (totalAnggota >= 3 && totalAnggota < 4) {
                    statusMessage = `<br><span class="text-success"><i class="fas fa-check-circle me-1"></i>Tim sudah memenuhi syarat minimal 3 anggota. Anda dapat menambahkan ${4 - totalAnggota} anggota lagi.</span>`;
                } else {
                    statusMessage = `<br><span class="text-success"><i class="fas fa-check-circle me-1"></i>Tim sudah lengkap dengan 4 anggota.</span>`;
                }
                
                infoAnggota.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Informasi:</strong> Tim harus memiliki minimal 3 anggota dan maksimal 4 anggota. Saat ini sudah ada <span id="jumlahAnggotaExisting">${totalAnggota}</span> anggota.
                    ${statusMessage}
                `;
            }
        }

        // Fungsi untuk hapus anggota
        function hapusAnggota(anggotaId) {
            const card = document.querySelector(`[data-anggota-id="${anggotaId}"]`);
            if (card) {
                card.remove();
                
                // Renumber anggota yang tersisa
                const container = document.getElementById('containerAnggota');
                const remainingCards = container.querySelectorAll('.anggota-card');
                remainingCards.forEach((card, index) => {
                    const newId = index + 1;
                    card.setAttribute('data-anggota-id', newId);
                    
                    // Update header
                    const header = card.querySelector('h6');
                    if (header) {
                        header.innerHTML = `<i class="fas fa-user-plus me-2"></i>Anggota ${newId}`;
                    }
                    
                    // Update onclick untuk tombol hapus
                    const hapusBtn = card.querySelector('.btn-hapus-anggota');
                    if (hapusBtn) {
                        hapusBtn.onclick = () => hapusAnggota(newId);
                        hapusBtn.style.display = index === 0 ? 'none' : 'flex';
                    }
                    
                                         // Update nama field
                     const inputs = card.querySelectorAll('input');
                     inputs.forEach(input => {
                         const name = input.getAttribute('name');
                         if (name) {
                             const newName = name.replace(/_\d+$/, `_${newId}`);
                             input.setAttribute('name', newName);
                         }
                     });
                 });
                 
                 // Cek dan update tombol "Tambah Anggota"
                 cekTombolTambahAnggota();
             }
         }

        // Inisialisasi DataTable
        $(document).ready(function() {
            // Cek apakah tabel ada sebelum inisialisasi
            const table = document.getElementById('table1');
            if (table) {
                try {
                    $('#table1').DataTable({
                        responsive: true,
                        language: {
                            // Gunakan konfigurasi bahasa Indonesia langsung untuk menghindari CORS
                            "sProcessing": "Sedang memproses...",
                            "sLengthMenu": "Tampilkan _MENU_ entri",
                            "sZeroRecords": "Tidak ditemukan data yang sesuai",
                            "sInfo": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                            "sInfoEmpty": "Menampilkan 0 sampai 0 dari 0 entri",
                            "sInfoFiltered": "(disaring dari _MAX_ entri keseluruhan)",
                            "sInfoPostFix": "",
                            "sSearch": "Cari:",
                            "sUrl": "",
                            "oPaginate": {
                                "sFirst": "Pertama",
                                "sPrevious": "Sebelumnya",
                                "sNext": "Selanjutnya",
                                "sLast": "Terakhir"
                            }
                        }
                    });
                } catch (error) {
                    console.warn('DataTable initialization failed:', error);
                }
            }
            
            // Konfigurasi modal agar bisa ditutup saat klik di luar
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                // Hapus atribut data-bs-backdrop="static" jika ada
                modal.removeAttribute('data-bs-backdrop');
                modal.removeAttribute('data-bs-keyboard');
                
                // Pastikan modal bisa ditutup dengan klik di luar
                modal.setAttribute('data-bs-backdrop', 'true');
                modal.setAttribute('data-bs-keyboard', 'true');
            });
            
            // Event listener untuk menutup modal saat klik di backdrop
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    const modal = bootstrap.Modal.getInstance(event.target);
                    if (modal) {
                        modal.hide();
                    }
                }
            });
            
            // Event listener untuk menutup modal dengan ESC key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const openModals = document.querySelectorAll('.modal.show');
                    openModals.forEach(modalElement => {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                    });
                }
            });
            
            // Event listener untuk tombol close modal
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('btn-close') || 
                    event.target.closest('.btn-close')) {
                    const modalElement = event.target.closest('.modal');
                    if (modalElement) {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                    }
                }
            });
            
            // Event listener untuk file input
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                // Set default text
                input.style.setProperty('--file-name', '"Tidak ada file yang dipilih"');
                input.style.setProperty('--file-color', '#6b7280');
                
                input.addEventListener('change', function() {
                    if (this.files[0]) {
                        // File dipilih
                        const fileName = this.files[0].name;
                        this.style.setProperty('--file-name', `"${fileName}"`);
                        this.style.setProperty('--file-color', '#374151');
                    } else {
                        // Tidak ada file
                        this.style.setProperty('--file-name', '"Tidak ada file yang dipilih"');
                        this.style.setProperty('--file-color', '#6b7280');
                    }
                });
            });
            
            // Inisialisasi semua modal dengan konfigurasi yang benar
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modalElement => {
                // Pastikan modal bisa ditutup dengan klik di luar
                modalElement.setAttribute('data-bs-backdrop', 'true');
                modalElement.setAttribute('data-bs-keyboard', 'true');
                
                // Hapus event listener onclick yang mungkin mengganggu
                const closeButtons = modalElement.querySelectorAll('.btn-close, [data-bs-dismiss="modal"]');
                closeButtons.forEach(button => {
                    button.removeAttribute('onclick');
                });
            });
        });

    function editProposal(proposalId) {
        Swal.fire({
            title: 'Memuat Data Proposal...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        fetch(`/mahasiswa/get_proposal_detail/${proposalId}`)
            .then(response => response.json())
            .then(data => {
                Swal.close();
                if (data.success) {
                    const p = data.proposal;
                    document.getElementById('edit_proposal_id').value = p.id;
                    // Helper untuk set input, jika kosong/null jadi '-'
                    function setInput(id, val) {
                        document.getElementById(id).value = (val && val !== '') ? val : '-';
                    }
                    setInput('edit_judul_usaha', p.judul_usaha);
                    // Set kategori
                    const kategoriSelect = document.getElementById('edit_kategori');
                    let kategoriVal = (p.kategori || '').trim().toLowerCase();
                    let kategoriFound = false;
                    for (let opt of kategoriSelect.options) {
                        if (opt.value.trim().toLowerCase() === kategoriVal) {
                            kategoriSelect.value = opt.value;
                            kategoriFound = true;
                            break;
                        }
                    }
                    if (!kategoriFound) {
                        const opt = document.createElement('option');
                        opt.value = kategoriVal ? p.kategori : '-';
                        opt.text = kategoriVal ? p.kategori : '-';
                        opt.selected = true;
                        kategoriSelect.appendChild(opt);
                    }
                    setInput('edit_tahapan_usaha', p.tahapan_usaha);
                    setInput('edit_merk_produk', p.merk_produk);
                    setInput('edit_nib', p.nib);
                    setInput('edit_tahun_nib', p.tahun_nib);
                    setInput('edit_platform_penjualan', p.platform_penjualan);
                    // Set dropdown dosen
                    const dosenSelect = document.getElementById('edit_dosen_pembimbing');
                    let dosenVal = (p.dosen_pembimbing || '').trim().toLowerCase();
                    let dosenFound = false;
                    for (let opt of dosenSelect.options) {
                        if (opt.value.trim().toLowerCase() === dosenVal) {
                            dosenSelect.value = opt.value;
                            dosenFound = true;
                            break;
                        }
                    }
                    if (!dosenFound) {
                        const opt = document.createElement('option');
                        opt.value = dosenVal ? p.dosen_pembimbing : '-';
                        opt.text = dosenVal ? p.dosen_pembimbing : '-';
                        opt.selected = true;
                        dosenSelect.appendChild(opt);
                    }
                    const event = new Event('change');
                    dosenSelect.dispatchEvent(event);
                    // NID/prodi dosen
                    if (p.nid_dosen && dosenFound) {
                        setInput('edit_nid_dosen', p.nid_dosen);
                        setInput('edit_program_studi_dosen', p.program_studi_dosen);
                    } else if (!dosenFound) {
                        setInput('edit_nid_dosen', p.nid_dosen);
                        setInput('edit_program_studi_dosen', p.program_studi_dosen);
                    }
                    const modal = new bootstrap.Modal(document.getElementById('modalEditProposal'));
                    modal.show();
                    
                    // Pastikan dropdown dosen tetap terlihat dan berfungsi
                    setTimeout(() => {
                        const dosenSelect = document.getElementById('edit_dosen_pembimbing');
                        if (dosenSelect) {
                            dosenSelect.style.display = 'block';
                            dosenSelect.style.visibility = 'visible';
                            dosenSelect.style.opacity = '1';
                        }
                    }, 100);
                } else {
                    Swal.fire('Gagal', data.message || 'Gagal memuat data proposal', 'error');
                }
            })
            .catch(() => {
                Swal.close();
                Swal.fire('Error', 'Terjadi kesalahan saat memuat data proposal', 'error');
            });
    }

    document.getElementById('edit_dosen_pembimbing').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption && selectedOption.dataset) {
            document.getElementById('edit_nid_dosen').value = selectedOption.dataset.nip || '-';
            document.getElementById('edit_program_studi_dosen').value = selectedOption.dataset.prodi || '-';
        } else {
            document.getElementById('edit_nid_dosen').value = '-';
            document.getElementById('edit_program_studi_dosen').value = '-';
        }
    });

    document.getElementById('formEditProposal').addEventListener('submit', function(e) {
        e.preventDefault();
        const proposalId = document.getElementById('edit_proposal_id').value;
        const formData = new FormData(this);
        // Ganti semua value '-' menjadi string kosong sebelum submit
        for (let [key, value] of formData.entries()) {
            if (value === '-') formData.set(key, '');
        }
        fetch(`/mahasiswa/edit_proposal/${proposalId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Berhasil!',
                    text: 'Data proposal berhasil diperbarui.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => window.location.reload());
            } else {
                Swal.fire('Gagal', data.message || 'Gagal memperbarui data proposal', 'error');
            }
        })
        .catch(() => {
            Swal.fire('Error', 'Terjadi kesalahan saat memperbarui data proposal', 'error');
        });
    });

    // Perbaiki tampilan detail proposal (lihatProposal) agar field kosong tampil '-'
    function safeText(val) {
        return (val && val !== '') ? val : '-';
    }
    // Pada bagian isi detail proposal di JS lihatProposal, ganti:
    // document.getElementById('detailJudulUsaha').textContent = proposal.judul_usaha || '-';
    // menjadi:


    document.addEventListener('DOMContentLoaded', function() {
        {% if perlu_pilih_dosen_baru %}
        Swal.fire({
            icon: 'warning',
            title: 'Perubahan Dosen Pembimbing',
            html: 'Dosen pembimbing Anda telah dihapus oleh admin.<br>Silakan pilih dosen pembimbing baru melalui <b>Edit Proposal</b>.',
            confirmButtonText: 'Mengerti',
            confirmButtonColor: '#3085d6'
        });
        {% endif %}
    });

    document.addEventListener('DOMContentLoaded', function() {
        {% if peringatan_dosen_baru %}
        Swal.fire({
            icon: 'warning',
            title: 'Perubahan Dosen Pembimbing',
            html: 'Dosen pembimbing Anda telah dihapus atau dinonaktifkan oleh admin.<br>Silakan <b>Edit Proposal</b> dan pilih dosen pembimbing baru.',
            confirmButtonText: 'Mengerti',
            confirmButtonColor: '#3085d6'
        });
        {% endif %}
    });

    // Event listener untuk form tambah anggota tim
    const formTambahAnggota = document.getElementById('formTambahAnggota');
    if (formTambahAnggota) {
        formTambahAnggota.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validasi jumlah anggota minimal 3 dan maksimal 4
            const container = document.getElementById('containerAnggota');
            const anggotaCards = container.querySelectorAll('.anggota-card');
            const modal = document.getElementById('modalTambahAnggota');
            const existingCount = parseInt(modal.getAttribute('data-existing-count') || 0);
            const totalAnggota = existingCount + anggotaCards.length;
            
            // Validasi minimal 3 anggota
            if (totalAnggota < 3) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Jumlah Anggota Tidak Mencukupi',
                    text: `Tim harus memiliki minimal 3 anggota. Saat ini hanya ada ${totalAnggota} anggota.`,
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'Mengerti'
                });
                return;
            }
            
            // Validasi maksimal 4 anggota
            if (totalAnggota > 4) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Jumlah Anggota Melebihi Batas',
                    text: `Tim maksimal terdiri dari 4 anggota. Saat ini ada ${totalAnggota} anggota.`,
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'Mengerti'
                });
                return;
            }
            
            const formData = new FormData(this);
            fetch(this.action || window.location.pathname, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json ? res.json() : res)
            .then(data => {
                if (data && data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: 'Anggota tim berhasil disimpan.',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => window.location.reload());
                } else {
                    Swal.fire('Gagal', (data && data.message) || 'Gagal menyimpan anggota', 'error');
                }
            })
            .catch(() => {
                Swal.fire('Error', 'Terjadi kesalahan saat menyimpan anggota', 'error');
            });
        });
    }

    // Fungsi untuk melihat komentar pembimbing
    function lihatKomentarPembimbing(proposalId, komentar, tanggalKomentar) {
        // Format tanggal
        function formatDate(dateString) {
            if (!dateString || dateString === '') return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        const tanggalFormatted = formatDate(tanggalKomentar);

        Swal.fire({
            title: 'Komentar Pembimbing',
            html: `
                <div class="text-start">
                    <div class="mb-3">
                        <label class="fw-bold text-primary">Komentar:</label>
                        <div class="mt-2 p-3 bg-light rounded" style="border-left: 4px solid #6366f1;">
                            <p class="mb-0" style="white-space: pre-wrap; line-height: 1.6; color: #333;">${komentar || 'Tidak ada komentar'}</p>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="fw-bold text-secondary">Tanggal Komentar:</label>
                        <div class="mt-1">
                            <i class="fa-solid fa-calendar-alt me-2"></i>
                            <span>${tanggalFormatted}</span>
                        </div>
                    </div>
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Tutup',
            confirmButtonColor: '#6366f1',
            width: '650px',
            customClass: {
                popup: 'swal-wide',
                content: 'text-start'
            }
        });
    }

    // Cek status revisi saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
        // Cek apakah ada proposal dengan status revisi
        const revisiRows = document.querySelectorAll('tr[data-status="revisi"]');
        if (revisiRows.length > 0) {
            // Ambil data proposal revisi pertama
            const revisiRow = revisiRows[0];
            const proposalId = revisiRow.getAttribute('data-proposal-id');
            const judulProposal = revisiRow.querySelector('td:nth-child(2)').textContent.trim();
            
            // Cek jenis revisi terlebih dahulu
            fetch(`/mahasiswa/get_jenis_revisi/${proposalId}`)
                .then(response => response.json())
                .then(revisiData => {
                    if (revisiData.success) {
                        const jenisRevisi = revisiData.jenis_revisi;
                        
                        // Jika ada revisi anggaran, tampilkan SweetAlert revisi anggaran
                        if (jenisRevisi.includes('anggaran')) {
                            showRevisiAnggaranAlert(proposalId, judulProposal);
                        }
                        // Jika ada revisi file proposal, tampilkan SweetAlert revisi file
                        else if (jenisRevisi.includes('file')) {
                            showRevisiFileAlert(proposalId, judulProposal);
                        }
                        // Jika keduanya, tampilkan SweetAlert kombinasi
                        else if (jenisRevisi.length > 1) {
                            showRevisiKombinasiAlert(proposalId, judulProposal);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching jenis revisi:', error);
                });
        }
    });
    
    // Function untuk menampilkan SweetAlert revisi anggaran
    function showRevisiAnggaranAlert(proposalId, judulProposal) {
        fetch(`/mahasiswa/get_anggaran_revisi/${proposalId}`)
            .then(response => response.json())
            .then(data => {
                let anggaranRevisiHtml = '';
                if (data.success && data.anggaran_revisi.length > 0) {
                    anggaranRevisiHtml = `
                        <div class="alert alert-danger border-0" style="background-color: #fee2e2; color: #991b1b;">
                            <i class="fa-solid fa-exclamation-circle me-2"></i>
                            <strong>Anggaran yang perlu direvisi:</strong>
                            <div class="mt-2">
                                ${data.anggaran_revisi.map(item => `
                                    <div class="border-start border-danger ps-2 mb-1">
                                        <small><strong>${item.nama_barang}</strong></small><br>
                                        <small>Jumlah: Rp ${parseInt(item.jumlah).toLocaleString('id-ID')} | 
                                               Nilai Bantuan: Rp ${parseInt(item.nilai_bantuan || 0).toLocaleString('id-ID')}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            
            // Tampilkan SweetAlert untuk status revisi
            Swal.fire({
                title: '<span style="color:#f59e0b;"><i class="fa-solid fa-exclamation-triangle me-2"></i>Proposal Perlu Revisi!</span>',
                html: `
                    <div class="text-start">
                        <div class="mb-2"><strong>Judul Proposal:</strong> <span style="color:#374151;">${judulProposal}</span></div>
                        <div class="mb-3">
                            <div class="alert alert-warning border-0" style="background-color: #fef3c7; color: #92400e;">
                                <i class="fa-solid fa-money-bill-wave me-2"></i>
                                <strong>Revisi Anggaran Diperlukan!</strong>
                            </div>
                            <p class="mb-2">Proposal Anda telah diminta untuk <span class="fw-bold text-warning">revisi</span> karena:</p>
                            <ul class="ps-3" style="color:#374151;">
                                <li><strong>Jumlah anggaran</strong> melebihi <strong>nilai bantuan</strong> yang ditetapkan reviewer</li>
                                <li>Anda harus <strong>menyesuaikan anggaran</strong> agar tidak melebihi nilai bantuan</li>
                                <li>Setelah revisi, proposal akan dikirim ulang ke pembimbing</li>
                            </ul>
                        </div>
                        ${anggaranRevisiHtml}
                        <div class="alert alert-info border-0" style="background-color: #dbeafe; color: #1e40af;">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <strong>Langkah yang harus dilakukan:</strong>
                            <ol class="ps-3 mt-2 mb-0">
                                <li>Edit <strong>anggaran awal</strong> dan <strong>anggaran bertumbuh</strong></li>
                                <li>Pastikan jumlah anggaran ≤ nilai bantuan yang ditetapkan</li>
                                <li>Edit file proposal jika diperlukan</li>
                                <li>Ajukan ulang ke pembimbing</li>
                            </ol>
                        </div>
                    </div>
                `,
                icon: 'warning',
                confirmButtonText: 'Mengerti',
                confirmButtonColor: '#f59e0b',
                width: '650px',
                customClass: {
                    popup: 'swal-wide',
                    content: 'text-start'
                }
            });
            })
            .catch(error => {
                console.error('Error fetching anggaran revisi:', error);
                // Tampilkan SweetAlert tanpa data anggaran jika terjadi error
                Swal.fire({
                    title: '<span style="color:#f59e0b;"><i class="fa-solid fa-exclamation-triangle me-2"></i>Proposal Perlu Revisi!</span>',
                    html: `
                        <div class="text-start">
                            <div class="mb-2"><strong>Judul Proposal:</strong> <span style="color:#374151;">${judulProposal}</span></div>
                            <div class="mb-3">
                                <div class="alert alert-warning border-0" style="background-color: #fef3c7; color: #92400e;">
                                    <i class="fa-solid fa-money-bill-wave me-2"></i>
                                    <strong>Revisi Anggaran Diperlukan!</strong>
                                </div>
                                <p class="mb-2">Proposal Anda telah diminta untuk <span class="fw-bold text-warning">revisi</span> karena jumlah anggaran melebihi nilai bantuan yang ditetapkan reviewer.</p>
                            </div>
                            <div class="alert alert-info border-0" style="background-color: #dbeafe; color: #1e40af;">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                <strong>Langkah yang harus dilakukan:</strong>
                                <ol class="ps-3 mt-2 mb-0">
                                    <li>Edit <strong>anggaran awal</strong> dan <strong>anggaran bertumbuh</strong></li>
                                    <li>Pastikan jumlah anggaran ≤ nilai bantuan yang ditetapkan</li>
                                    <li>Edit file proposal jika diperlukan</li>
                                    <li>Ajukan ulang ke pembimbing</li>
                                </ol>
                            </div>
                        </div>
                    `,
                    icon: 'warning',
                    confirmButtonText: 'Mengerti',
                    confirmButtonColor: '#f59e0b',
                    width: '650px',
                    customClass: {
                        popup: 'swal-wide',
                        content: 'text-start'
                    }
                });
            });
    }
    
    // Function untuk menampilkan SweetAlert revisi file proposal
    function showRevisiFileAlert(proposalId, judulProposal) {
        Swal.fire({
            title: '<span style="color:#dc3545;"><i class="fa-solid fa-file-circle-exclamation me-2"></i>File Proposal Perlu Revisi!</span>',
            html: `
                <div class="text-start">
                    <div class="mb-2"><strong>Judul Proposal:</strong> <span style="color:#374151;">${judulProposal}</span></div>
                    <div class="mb-3">
                        <div class="alert alert-danger border-0" style="background-color: #f8d7da; color: #721c24;">
                            <i class="fa-solid fa-file-pen me-2"></i>
                            <strong>Revisi File Proposal Diperlukan!</strong>
                        </div>
                        <p class="mb-2">File proposal Anda telah diminta untuk <span class="fw-bold text-danger">revisi</span> oleh dosen pembimbing.</p>
                        <ul class="ps-3" style="color:#374151;">
                            <li>Klik tombol <i class="fa-solid fa-exclamation-triangle text-warning"></i> untuk melihat komentar pembimbing</li>
                            <li>Klik tombol <i class="fa-solid fa-edit text-warning"></i> untuk edit file proposal</li>
                            <li>Ajukan ulang proposal setelah revisi</li>
                        </ul>
                    </div>
                    <div class="alert alert-info border-0" style="background-color: #dbeafe; color: #1e40af;">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        <strong>Langkah yang harus dilakukan:</strong>
                        <ol class="ps-3 mt-2 mb-0">
                            <li>Baca komentar revisi dari pembimbing</li>
                            <li>Edit file proposal sesuai komentar</li>
                            <li>Upload file proposal yang sudah direvisi</li>
                            <li>Ajukan ulang ke pembimbing</li>
                        </ol>
                    </div>
                    </div>
                `,
            icon: 'error',
                confirmButtonText: 'Mengerti',
            confirmButtonColor: '#dc3545',
                width: '650px',
                customClass: {
                    popup: 'swal-wide',
                    content: 'text-start'
                }
            });
    }
    
    // Function untuk menampilkan SweetAlert kombinasi revisi
    function showRevisiKombinasiAlert(proposalId, judulProposal) {
        fetch(`/mahasiswa/get_anggaran_revisi/${proposalId}`)
            .then(response => response.json())
            .then(data => {
                let anggaranRevisiHtml = '';
                if (data.success && data.anggaran_revisi.length > 0) {
                    anggaranRevisiHtml = `
                        <div class="alert alert-danger border-0" style="background-color: #fee2e2; color: #991b1b;">
                            <i class="fa-solid fa-exclamation-circle me-2"></i>
                            <strong>Anggaran yang perlu direvisi:</strong>
                            <div class="mt-2">
                                ${data.anggaran_revisi.map(item => `
                                    <div class="border-start border-danger ps-2 mb-1">
                                        <small><strong>${item.nama_barang}</strong></small><br>
                                        <small>Jumlah: Rp ${parseInt(item.jumlah).toLocaleString('id-ID')} | 
                                               Nilai Bantuan: Rp ${parseInt(item.nilai_bantuan || 0).toLocaleString('id-ID')}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                Swal.fire({
                    title: '<span style="color:#dc3545;"><i class="fa-solid fa-exclamation-triangle me-2"></i>Proposal & Anggaran Perlu Revisi!</span>',
                    html: `
                        <div class="text-start">
                            <div class="mb-2"><strong>Judul Proposal:</strong> <span style="color:#374151;">${judulProposal}</span></div>
                            <div class="mb-3">
                                <div class="alert alert-danger border-0" style="background-color: #f8d7da; color: #721c24;">
                                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                                    <strong>Revisi Lengkap Diperlukan!</strong>
                                </div>
                                <p class="mb-2">Proposal Anda memerlukan revisi <span class="fw-bold text-danger">file proposal</span> dan <span class="fw-bold text-warning">anggaran</span>.</p>
                            </div>
                            ${anggaranRevisiHtml}
                            <div class="alert alert-info border-0" style="background-color: #dbeafe; color: #1e40af;">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                <strong>Langkah yang harus dilakukan:</strong>
                                <ol class="ps-3 mt-2 mb-0">
                                    <li>Baca komentar revisi dari pembimbing</li>
                                    <li>Edit file proposal sesuai komentar</li>
                                    <li>Edit anggaran awal dan anggaran bertumbuh</li>
                                    <li>Pastikan jumlah anggaran ≤ nilai bantuan</li>
                                    <li>Upload file proposal yang sudah direvisi</li>
                                    <li>Ajukan ulang ke pembimbing</li>
                                </ol>
                            </div>
                        </div>
                    `,
                    icon: 'error',
                    confirmButtonText: 'Mengerti',
                    confirmButtonColor: '#dc3545',
                    width: '650px',
                    customClass: {
                        popup: 'swal-wide',
                        content: 'text-start'
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching anggaran revisi:', error);
            });
    }

    // Fungsi untuk edit proposal dengan status revisi (hanya file yang bisa diedit)
    function editProposalRevisi(proposalId) {
        Swal.fire({
            title: 'Memuat Data Proposal...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        fetch(`/mahasiswa/get_proposal_detail/${proposalId}`)
            .then(response => response.json())
            .then(data => {
                Swal.close();
                if (data.success) {
                    const p = data.proposal;
                    document.getElementById('edit_proposal_id').value = p.id;
                    
                    // Untuk status revisi, hanya file proposal yang bisa diedit
                    // Semua field lain di-disable dan diisi dengan data yang ada
                    function setInputReadonly(id, val) {
                        const input = document.getElementById(id);
                        input.value = (val && val !== '') ? val : '-';
                        input.readOnly = true;
                        input.style.backgroundColor = '#f8f9fa';
                        input.style.cursor = 'not-allowed';
                    }
                    
                    // Set semua field sebagai readonly kecuali file proposal
                    setInputReadonly('edit_judul_usaha', p.judul_usaha);
                    setInputReadonly('edit_merk_produk', p.merk_produk);
                    setInputReadonly('edit_nib', p.nib);
                    setInputReadonly('edit_tahun_nib', p.tahun_nib);
                    setInputReadonly('edit_platform_penjualan', p.platform_penjualan);
                    setInputReadonly('edit_nid_dosen', p.nid_dosen);
                    setInputReadonly('edit_program_studi_dosen', p.program_studi_dosen);
                    
                    // Set dropdown kategori sebagai readonly
                    const kategoriSelect = document.getElementById('edit_kategori');
                    kategoriSelect.value = p.kategori || '';
                    kategoriSelect.disabled = true;
                    kategoriSelect.style.backgroundColor = '#f8f9fa';
                    kategoriSelect.style.cursor = 'not-allowed';
                    
                    // Set dropdown tahapan usaha sebagai readonly
                    const tahapanSelect = document.getElementById('edit_tahapan_usaha');
                    tahapanSelect.value = p.tahapan_usaha || '';
                    tahapanSelect.disabled = true;
                    tahapanSelect.style.backgroundColor = '#f8f9fa';
                    tahapanSelect.style.cursor = 'not-allowed';
                    
                    // Set dropdown dosen sebagai readonly
                    const dosenSelect = document.getElementById('edit_dosen_pembimbing');
                    dosenSelect.value = p.dosen_pembimbing || '';
                    dosenSelect.disabled = true;
                    dosenSelect.style.backgroundColor = '#f8f9fa';
                    dosenSelect.style.cursor = 'not-allowed';
                    
                    // Pastikan dropdown dosen tetap tampil dengan menambahkan opsi jika tidak ada
                    if (p.dosen_pembimbing && !Array.from(dosenSelect.options).some(option => option.value === p.dosen_pembimbing)) {
                        const newOption = document.createElement('option');
                        newOption.value = p.dosen_pembimbing;
                        newOption.textContent = p.dosen_pembimbing;
                        dosenSelect.appendChild(newOption);
                        dosenSelect.value = p.dosen_pembimbing;
                    }
                    
                    // File proposal tetap bisa diubah
                    const fileInput = document.getElementById('edit_file_proposal');
                    fileInput.readOnly = false;
                    fileInput.style.backgroundColor = '#fff';
                    fileInput.style.cursor = 'pointer';
                    
                    // Tambahkan label khusus untuk status revisi
                    const modalTitle = document.getElementById('modalEditProposalLabel');
                    modalTitle.textContent = 'Edit Proposal (Revisi) - Hanya File Proposal';
                    
                    // Tambahkan alert info di modal
                    const modalBody = document.querySelector('#modalEditProposal .modal-body');
                    const existingAlert = modalBody.querySelector('.alert-info');
                    if (!existingAlert) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-info alert-dismissible fade show mb-3';
                        alertDiv.innerHTML = `
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Status Revisi:</strong> Hanya file proposal yang dapat diubah. 
                            Setelah upload file baru, file lama akan otomatis terhapus.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        modalBody.insertBefore(alertDiv, modalBody.firstChild);
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('modalEditProposal'));
                    modal.show();
                    
                    // Pastikan dropdown dosen tetap terlihat dan berfungsi
                    setTimeout(() => {
                        const dosenSelect = document.getElementById('edit_dosen_pembimbing');
                        if (dosenSelect) {
                            dosenSelect.style.display = 'block';
                            dosenSelect.style.visibility = 'visible';
                            dosenSelect.style.opacity = '1';
                        }
                    }, 100);
                } else {
                    Swal.fire('Gagal', data.message || 'Gagal memuat data proposal', 'error');
                }
            })
            .catch(() => {
                Swal.close();
                Swal.fire('Error', 'Terjadi kesalahan saat memuat data proposal', 'error');
            });
    }

    // Inisialisasi tooltip global untuk semua elemen dengan data-bs-toggle="tooltip"
    function initializeTooltips() {
        // Dispose semua tooltip yang sudah ada
        const existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        existingTooltips.forEach(element => {
            const tooltip = bootstrap.Tooltip.getInstance(element);
            if (tooltip) {
                tooltip.dispose();
            }
        });

        // Inisialisasi tooltip baru
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl, {
                trigger: 'hover focus',
                placement: 'top',
                animation: true
            });
        });
    }

    // Inisialisasi tooltip saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
        initializeTooltips();
    });

    // Inisialisasi tooltip untuk elemen yang ditambahkan secara dinamis
    function initializeTooltipsForDynamicContent() {
        setTimeout(() => {
            initializeTooltips();
        }, 100);
    }

    // Override fungsi lihatProposal untuk menambahkan inisialisasi tooltip
    const originalLihatProposal = window.lihatProposal;
    window.lihatProposal = function(proposalId) {
        if (originalLihatProposal) {
            originalLihatProposal(proposalId);
        }
        
        // Inisialisasi tooltip setelah modal dibuka
        setTimeout(() => {
            initializeTooltips();
        }, 200);
    };
    </script>

</body>

</html>
