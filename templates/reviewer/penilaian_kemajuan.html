<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penilaian Laporan Kemajuan - AYMP UNJAYA</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='lodaf/unjaya.png') }}" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/bootstrap.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-papm6Q+..." crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            position: relative;
            padding: 0 1rem;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 4rem;
            position: relative;
            text-align: center;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: #10b981;
            color: white;
        }

        .step.completed .step-number {
            background: #059669;
            color: white;
        }

        .step.pending .step-number {
            background: #e5e7eb;
            color: #6b7280;
        }

        .step-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            line-height: 1.2;
        }

        .step.active .step-title {
            color: #10b981;
        }

        .step.completed .step-title {
            color: #059669;
        }

        .step.pending .step-title {
            color: #6b7280;
        }

        .step-connector {
            position: absolute;
            top: 20px;
            left: 60px;
            width: 120px;
            height: 2px;
            background: #e5e7eb;
            z-index: -1;
        }

        .step-connector.active {
            background: #10b981;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        .btn {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #10b981;
            border-color: #10b981;
        }

        .btn-primary:hover {
            background: #059669;
            border-color: #059669;
        }

        .btn-secondary {
            background: #6b7280;
            border-color: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
            border-color: #4b5563;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.75rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
        }

        .score-input {
            width: 80px;
            text-align: center;
        }
        
        .score-input.invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        .score-input.valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .total-row {
            background: #f8fafc;
            font-weight: 600;
        }
        
        .total-row.calculating {
            background: #fef3c7;
            position: relative;
        }
        
        .total-row.calculating::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #10b981, #059669);
            animation: loading 1s infinite;
        }
        
        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .nilai-display {
            font-weight: 600;
            color: #10b981;
            transition: all 0.3s ease;
        }
        
        .nilai-display.updated {
            background: #d1fae5;
            padding: 2px 6px;
            border-radius: 4px;
            animation: highlight 0.5s ease;
        }
        
        @keyframes highlight {
            0% { background: #10b981; color: white; }
            100% { background: #d1fae5; color: #10b981; }
        }

        .quill-editor {
            height: 300px;
        }

        .ql-editor {
            min-height: 250px;
        }

        .card-footer {
            background: #f8fafc;
            border-top: 1px solid #e9ecef;
            padding: 1rem 1.5rem;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }

        .alert {
            border-radius: 8px;
            border: none;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Animation for step transitions */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .step-indicator {
                flex-direction: column;
                align-items: center;
                padding: 0;
            }
            
            .step {
                margin: 1rem 0;
                flex-direction: column;
            }
            
            .step-connector {
                display: none;
            }
        }

        .rekomendasi-dropdown {
            min-width: 200px;
        }
    </style>

    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/perfect-scrollbar/perfect-scrollbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/bootstrap-icons/bootstrap-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/app.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/sweetalert2/sweetalert2.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='assets/images/favicon.svg') }}" type="image/x-icon">
</head>

<body>
    <div id="app">
        <div id="sidebar" class="active">
            <div class="sidebar-wrapper active">
                <div class="sidebar-header">
                    <div class="d-flex justify-content-between">
                        <div class="logo">
                            <a href="{{ url_for('reviewer.dashboard') }}"><img src="{{ url_for('static', filename='assets/images/logo/logo.svg') }}" style="width: 110px; height: auto;" alt="Logo" srcset=""></a>
                        </div>
                        <div class="toggler">
                            <a href="#" class="sidebar-hide d-xl-none d-block"><i class="bi bi-x bi-middle"></i></a>
                        </div>
                    </div>
                </div>
                <div class="sidebar-menu">
                    <ul class="menu">
                        <li class="sidebar-title">Menu</li>

                        <li class="sidebar-item">
                            <a href="{{ url_for('reviewer.dashboard') }}" class='sidebar-link'>
                                <i class="bi bi-speedometer2"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>

                        <li class="sidebar-item">
                            <a href="{{ url_for('reviewer.proposal') }}" class='sidebar-link'>
                                <i class="bi bi-file-earmark-text"></i>
                                <span>Proposal untuk Review</span>
                            </a>
                        </li>

                        <li class="sidebar-item active">
                            <a href="{{ url_for('reviewer.daftar_mahasiswa_laporan_kemajuan') }}" class='sidebar-link'>
                                <i class="bi bi-file-earmark-text"></i>
                                <span>Laporan Kemajuan</span>
                            </a>
                        </li>
                        <li class="sidebar-item ">
                            <a href="{{ url_for('reviewer.daftar_mahasiswa_laporan_akhir') }}" class='sidebar-link'>
                                <i class="bi bi-file-earmark-text"></i>
                                <span>Laporan Akhir</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="{{ url_for('index') }}" class='sidebar-link'>
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Logout</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <button class="sidebar-toggler btn x"><i data-feather="x"></i></button>
            </div>
        </div>
        <div id="main">
            <header class="mb-3">
                <a href="#" class="burger-btn d-block d-xl-none">
                    <i class="bi bi-justify fs-3"></i>
                </a>
            </header>

            <div class="page-heading">
                <div class="page-title">
                    <div class="row">
                        <div class="col-12 col-md-6 order-md-1 order-last">
                            <h3>Penilaian Laporan Kemajuan</h3>
                            <p class="text-subtitle text-muted">Penilaian laporan kemajuan mahasiswa.</p>
                        </div>
                        <div class="col-12 col-md-6 order-md-2 order-first">
                            <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="{{ url_for('reviewer.dashboard') }}">Dashboard</a></li>
                                    <li class="breadcrumb-item"><a href="{{ url_for('reviewer.daftar_mahasiswa_laporan_kemajuan') }}">Laporan Kemajuan</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Penilaian Laporan Kemajuan</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>

                <section class="section">
                    <div class="container-fluid mt-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-star-fill me-2"></i>
                                    Penilaian Laporan Kemajuan
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Step Indicator -->
                                <div class="step-indicator">
                                    <div class="step active" data-step="1">
                                        <div class="step-number">1</div>
                                        <div class="step-title">Laporan Kemajuan</div>
                                        <div class="step-connector active"></div>
                                    </div>
                                    <div class="step pending" data-step="2">
                                        <div class="step-number">2</div>
                                        <div class="step-title">Catatan</div>
                                        <div class="step-connector"></div>
                                    </div>
                                    <div class="step pending" data-step="3">
                                        <div class="step-number">3</div>
                                        <div class="step-title">Rekomendasi</div>
                                    </div>
                                </div>

                                <!-- Progress Bar -->
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 33.33%"></div>
                                </div>

                                <!-- Step Content -->
                                <div class="step-content active" id="step1">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Petunjuk:</strong> Berikan skor untuk setiap pertanyaan berdasarkan bobot yang telah ditentukan. Skor maksimal untuk setiap pertanyaan ditentukan oleh admin.
                                    </div>
                                    
                                    <div id="guardCard" class="alert alert-warning d-none" role="alert" style="border-radius: 12px;">
                                        <i class="bi bi-clock-history me-2"></i>
                                        <span id="guardMessage">Menunggu jadwal mulai penilaian...</span>
                                    </div>

                                    <div class="table-responsive" id="penilaianContainer">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th width="5%">No</th>
                                                    <th width="45%">Pertanyaan</th>
                                                    <th width="15%">Bobot (SKS)</th>
                                                    <th width="15%">Skor</th>
                                                    <th width="20%">Nilai</th>
                                                </tr>
                                            </thead>
                                            <tbody id="penilaianTable">
                                                <!-- Data penilaian akan diisi melalui JavaScript -->
                                            </tbody>
                                            <tfoot>
                                                <tr class="total-row">
                                                    <td colspan="2"><strong>TOTAL</strong></td>
                                                    <td><strong id="totalBobot">0</strong></td>
                                                    <td><strong id="totalSkor">0</strong></td>
                                                    <td><strong id="totalNilai">0.00%</strong></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>

                                <div class="step-content" id="step2">
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        <strong>Catatan:</strong> Berikan catatan detail tentang penilaian yang telah Anda lakukan. Catatan ini akan membantu mahasiswa memahami penilaian yang diberikan.
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="catatanEditor" class="form-label fw-bold">Catatan Penilaian</label>
                                        <div id="catatanEditor" class="quill-editor"></div>
                                    </div>
                                </div>

                                <div class="step-content" id="step3">
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle me-2"></i>
                                        <strong>Rekomendasi:</strong> Berdasarkan penilaian yang telah dilakukan, berikan rekomendasi untuk kelanjutan pendanaan.
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="rekomendasiPendanaan" class="form-label fw-bold">Rekomendasi Pendanaan</label>
                                                <select class="form-select rekomendasi-dropdown" id="rekomendasiPendanaan">
                                                    <option value="">Pilih rekomendasi...</option>
                                                    <option value="lanjutkan pendanaan">Lanjutkan Pendanaan</option>
                                                    <option value="berhenti pendanaan">Berhenti Pendanaan</option>
                                                </select>
                                                </div>
                                            </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="alasanRekomendasi" class="form-label fw-bold">Alasan Rekomendasi</label>
                                                <textarea class="form-control" id="alasanRekomendasi" rows="3" placeholder="Jelaskan alasan rekomendasi Anda..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Navigation Buttons -->
                                <div class="navigation-buttons">
                                    <button class="btn btn-secondary" id="btnPrevious" onclick="previousStep()" style="display: none;">
                                            <i class="bi bi-arrow-left me-2"></i>Sebelumnya
                                        </button>
                                    <div class="ms-auto">
                                        <button class="btn btn-primary" id="btnNext" onclick="nextStep()">
                                            Berikutnya<i class="bi bi-arrow-right ms-2"></i>
                                        </button>
                                        <button class="btn btn-success ms-2" id="btnSimpan" onclick="simpanPenilaian()" style="display: none;">
                                            <i class="bi bi-check-circle me-2"></i>Simpan Penilaian
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/vendors/jquery/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/vendors/sweetalert2/sweetalert2.all.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/mazer.js') }}"></script>
    
    <!-- Quill Editor JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <script>
        var currentStep = 1;
        var totalSteps = 3;
        var pertanyaanList = [];
        var quill;
        var penilaianData = {};
        
        $(document).ready(function() {
            loadJadwalPenilaian().always(function(){
            initializeQuill();
            loadPertanyaanPenilaian();
            loadSkorTersimpan();
            });
        });

        function loadJadwalPenilaian(){
            return $.get('{{ url_for('mahasiswa.get_pengaturan_jadwal_mhs') }}').done(function(resp){
                if (!resp || !resp.success) return;
                const d = resp.data || {};
                const mulai = d.reviewer_kemajuan_mulai;
                const selesai = d.reviewer_kemajuan_selesai;
                const now = new Date();
                const isBefore = (mulai && new Date(mulai) > now);
                const isAfter = (selesai && new Date(selesai) < now);
                let showGuard = false, message = '';
                if (isBefore) { showGuard = true; message = `Penilaian belum dibuka. Menunggu jadwal mulai: ${new Date(mulai).toLocaleString('id-ID')}`; }
                else if (isAfter) { showGuard = true; message = `Masa penilaian telah berakhir pada ${new Date(selesai).toLocaleString('id-ID')}. Penilaian baru tidak dapat ditambahkan (nilai otomatis 0).`; }
                if (showGuard) {
                    $('#guardMessage').text(message);
                    $('#guardCard').removeClass('d-none');
                    $('#btnNext, #btnSimpan').prop('disabled', true);
                    $('#penilaianContainer').addClass('opacity-50');
                    $(document).on('focus mousedown keydown', '.score-input, #btnNext, #btnSimpan', function(e){ e.preventDefault(); return false; });
                    // Jika sudah lewat jadwal selesai: set skor=0, catatan kosong, rekomendasi berhenti pendanaan
                    if (isAfter) {
                        $('.score-input').each(function(){ $(this).val(0); });
                        try { updateTotal(); } catch(e){}
                        try { if (window.quill) { quill.setText(''); } } catch(e){}
                        $('#rekomendasiPendanaan').val('berhenti pendanaan');
                    }
                }
            });
        }

        function initializeQuill() {
            quill = new Quill('#catatanEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'Tulis catatan penilaian Anda di sini...'
            });
        }

        function loadPertanyaanPenilaian() {
            $.ajax({
                url: '{{ url_for("reviewer.get_pertanyaan_penilaian_laporan_kemajuan") }}',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        pertanyaanList = response.data;
                        renderPertanyaanTable();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: response.message || 'Gagal memuat pertanyaan penilaian'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Terjadi kesalahan saat memuat pertanyaan penilaian'
                    });
                }
            });
        }

        function loadSkorTersimpan() {
            $.ajax({
                url: '{{ url_for("reviewer.get_skor_tersimpan_laporan_kemajuan") }}',
                type: 'GET',
                data: {
                    proposal_id: '{{ proposal_id }}'
                },
                success: function(response) {
                    if (response.success && response.data) {
                        // Isi skor yang sudah tersimpan
                        response.data.forEach(function(item) {
                            $(`input[data-id="${item.id_pertanyaan}"]`).val(item.skor);
                            hitungNilai($(`input[data-id="${item.id_pertanyaan}"]`)[0]);
                        });
                    }
                }
            });
        }

        function renderPertanyaanTable() {
            const tbody = $('#penilaianTable');
            tbody.empty();

            pertanyaanList.forEach(function(item, index) {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.pertanyaan}</td>
                        <td>${item.bobot}</td>
                        <td>
                            <input type="number" class="form-control score-input" 
                                   data-id="${item.id}" 
                                   data-bobot="${item.bobot}"
                                   data-skor-maksimal="${item.skor_maksimal}"
                                   min="1" max="${item.skor_maksimal}" 
                                   oninput="hitungNilai(this)" onblur="validateScore(this)">
                            <small class="form-text text-muted">Maksimal: ${item.skor_maksimal}</small>
                        </td>
                        <td class="nilai-display">0</td>
                    </tr>
                `;
                tbody.append(row);
            });
            
            updateTotal();
        }

        function hitungNilai(input) {
            let skor = parseFloat($(input).val()) || 0;
            const bobot = parseFloat($(input).data('bobot'));
            const skorMaksimal = parseFloat($(input).data('skor-maksimal'));
            
            // Validasi skor tidak boleh melebihi maksimal
            if (skor > skorMaksimal) {
                $(input).val(skorMaksimal);
                skor = skorMaksimal;
            }
            
            // Validasi skor tidak boleh negatif
            if (skor < 0) {
                $(input).val(0);
                skor = 0;
            }

            // RUMUS BARU: bobot × skor = nilai
            const nilai = bobot * skor;
            
            // Update nilai dengan efek visual
            const nilaiDisplay = $(input).closest('tr').find('.nilai-display');
            nilaiDisplay.text(nilai.toFixed(2));
            nilaiDisplay.addClass('updated');
            
            // Hapus class updated setelah animasi selesai
            setTimeout(() => {
                nilaiDisplay.removeClass('updated');
            }, 300);
            
            updateTotal();
        }

        function validateScore(input) {
            const skor = parseFloat($(input).val()) || 0;
            const skorMaksimal = parseFloat($(input).data('skor-maksimal'));
            
            $(input).removeClass('valid invalid');
            
            // Validasi skor tidak boleh melebihi maksimal
            if (skor > skorMaksimal) {
                $(input).val(skorMaksimal);
                $(input).addClass('invalid');
                
                // Tampilkan pesan peringatan
                Swal.fire({
                    title: 'Peringatan!',
                    text: `Skor tidak boleh melebihi ${skorMaksimal}`,
                    icon: 'warning',
                    confirmButtonColor: '#10b981',
                    timer: 2000,
                    showConfirmButton: false
                });
                return;
            }
            
            // Validasi skor tidak boleh negatif
            if (skor < 0) {
                $(input).val(0);
                $(input).addClass('invalid');
                return;
            }
            
            // Jika skor valid, berikan visual feedback positif
            if (skor >= 0 && skor <= skorMaksimal && skor > 0) {
                $(input).addClass('valid');
            } else if (skor === 0) {
                $(input).addClass('invalid');
            }
        }

        function updateTotal() {
            let totalBobot = 0;
            let totalSkor = 0;
            let totalNilai = 0;
            let skorMaksimalTertinggi = 0;
            
            // Hitung total bobot, total skor, dan cari skor maksimal tertinggi
            $('.score-input').each(function() {
                const bobot = parseFloat($(this).data('bobot'));
                const skor = parseFloat($(this).val()) || 0;
                const skorMaksimal = parseFloat($(this).data('skor-maksimal'));
                
                // RUMUS BARU: bobot × skor = nilai
                const nilai = bobot * skor;
                
                totalBobot += bobot;
                totalSkor += skor;
                totalNilai += nilai;
                
                // Cari skor maksimal tertinggi
                if (skorMaksimal > skorMaksimalTertinggi) {
                    skorMaksimalTertinggi = skorMaksimal;
                }
            });
            
            // RUMUS BARU: total nilai akhir = (total nilai / (total bobot × skor maksimal tertinggi)) × 100
            const nilaiAkhir = (totalBobot > 0 && skorMaksimalTertinggi > 0) ? 
                (totalNilai / (totalBobot * skorMaksimalTertinggi)) * 100 : 0;
            
            $('#totalBobot').text(totalBobot);
            $('#totalSkor').text(totalSkor);
            $('#totalNilai').text(nilaiAkhir.toFixed(2) + '%');
            
            // Simpan data untuk step berikutnya
            penilaianData = {
                totalSkor: totalSkor,
                totalNilai: totalNilai,
                totalBobot: totalBobot,
                skorMaksimalTertinggi: skorMaksimalTertinggi,
                nilaiAkhir: nilaiAkhir,
                detail: []
            };
            
            $('.score-input').each(function() {
                const id = $(this).data('id');
                const skor = parseFloat($(this).val()) || 0;
                const bobot = parseFloat($(this).data('bobot'));
                const skorMaksimal = parseFloat($(this).data('skor-maksimal'));
                
                // RUMUS BARU: bobot × skor = nilai
                const nilai = bobot * skor;
                
                penilaianData.detail.push({
                    id: parseInt(id),
                    skor: parseInt(skor),
                    bobot: parseFloat(bobot),
                    nilai: parseFloat(nilai)
                });
            });
        }

        function nextStep() {
            if (currentStep === 1) {
                // Validasi skor
                let semuaTerisi = true;
                $('.score-input').each(function() {
                    if (!$(this).val() || parseFloat($(this).val()) === 0) {
                        semuaTerisi = false;
                    }
                });

                if (!semuaTerisi) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Peringatan!',
                        text: 'Semua skor harus diisi sebelum melanjutkan'
                    });
                    return;
                }
            } else if (currentStep === 2) {
                const catatan = quill.getText().trim();
                if (!catatan) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Peringatan!',
                        text: 'Catatan penilaian harus diisi'
                    });
                    return;
                }
            }
            
            if (currentStep < totalSteps) {
                currentStep++;
                updateStepDisplay();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            // Update step indicator
            $('.step').removeClass('active completed').addClass('pending');
            for (let i = 1; i <= totalSteps; i++) {
                if (i < currentStep) {
                    $(`.step[data-step="${i}"]`).removeClass('pending').addClass('completed');
                } else if (i === currentStep) {
                    $(`.step[data-step="${i}"]`).removeClass('pending').addClass('active');
                }
            }

            // Update step content
            $('.step-content').removeClass('active');
            $(`#step${currentStep}`).addClass('active');

            // Update progress bar
            const progress = (currentStep / totalSteps) * 100;
            $('#progressFill').css('width', progress + '%');
            
            // Update navigation buttons
            if (currentStep === 1) {
                $('#btnPrevious').hide();
                $('#btnNext').show();
                $('#btnSimpan').hide();
            } else if (currentStep === 2) {
                $('#btnPrevious').show();
                $('#btnNext').show();
                $('#btnSimpan').hide();
            } else if (currentStep === 3) {
                $('#btnPrevious').show();
                $('#btnNext').hide();
                $('#btnSimpan').show();
            }
        }

        function simpanPenilaian() {
            return $.get('{{ url_for('mahasiswa.get_pengaturan_jadwal_mhs') }}').done(function(resp){
                const d = (resp && resp.data) ? resp.data : {};
                if (d.reviewer_kemajuan_selesai && new Date() > new Date(d.reviewer_kemajuan_selesai)) {
                    Swal.fire({ icon: 'error', title: 'Tidak Bisa Menyimpan', text: 'Masa penilaian telah berakhir. Nilai otomatis 0.' });
                    return;
                }
                // lanjut eksekusi simpan jika masih dalam jadwal
                submitSimpan();
            });
        }

        function submitSimpan(){
            const rekomendasiPendanaan = $('#rekomendasiPendanaan').val();
            const alasanRekomendasi = $('#alasanRekomendasi').val().trim();
            
            console.log('DEBUG: Rekomendasi pendanaan:', rekomendasiPendanaan);
            console.log('DEBUG: Alasan rekomendasi:', alasanRekomendasi);
            
            if (!rekomendasiPendanaan) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Peringatan!',
                    text: 'Rekomendasi pendanaan harus dipilih'
                });
                return;
            }

            if (!alasanRekomendasi) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Peringatan!',
                    text: 'Alasan rekomendasi harus diisi'
                });
                return;
            }
            
            // Validasi skor
            let semuaTerisi = true;
            let detailPenilaian = [];
            
            $('.score-input').each(function() {
                const skor = parseFloat($(this).val()) || 0;
                if (skor === 0) {
                    semuaTerisi = false;
                } else {
                    const id = $(this).data('id');
                    const bobot = $(this).data('bobot');
                    const skorMaksimal = $(this).data('skor-maksimal');
                    
                    // RUMUS BARU: bobot × skor = nilai
                    const nilai = bobot * skor;
                    
                    detailPenilaian.push({
                        id_pertanyaan: parseInt(id),
                        skor_diberikan: parseInt(skor),
                        bobot_pertanyaan: parseFloat(bobot),
                        skor_maksimal: parseInt(skorMaksimal),
                        nilai_terbobot: parseFloat(nilai)
                    });
                }
            });

            if (!semuaTerisi) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Peringatan!',
                    text: 'Semua skor harus diisi sebelum menyimpan penilaian'
                });
                return;
            }

            const komentarReviewer = quill.getText();
            
            // Tampilkan loading
            Swal.fire({
                title: 'Menyimpan Penilaian...',
                text: 'Mohon tunggu sebentar',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Debug: Log data yang akan dikirim
            console.log('DEBUG: Data yang akan dikirim ke server:');
            console.log('proposal_id:', '{{ proposal_id }}');
            console.log('komentar_reviewer:', komentarReviewer);
            console.log('rekomendasi_pendanaan:', rekomendasiPendanaan);
            console.log('alasan_rekomendasi:', alasanRekomendasi);
            console.log('detail_penilaian:', detailPenilaian);
            
            // Kirim data ke server
            $.ajax({
                url: '{{ url_for("reviewer.simpan_penilaian_laporan_kemajuan") }}',
                type: 'POST',
                data: {
                    proposal_id: '{{ proposal_id }}',
                    komentar_reviewer: komentarReviewer,
                    rekomendasi_pendanaan: rekomendasiPendanaan,
                    alasan_rekomendasi: alasanRekomendasi,
                    detail_penilaian: JSON.stringify(detailPenilaian)
                },
                success: function(response) {
                    Swal.close();
                    if (response.success) {
                    Swal.fire({
                        icon: 'success',
                            title: 'Berhasil!',
                            text: response.message,
                            showConfirmButton: false,
                            timer: 1500
                    }).then(() => {
                            window.location.href = '{{ url_for("reviewer.daftar_mahasiswa_laporan_kemajuan") }}';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                            title: 'Error!',
                            text: response.message || 'Gagal menyimpan penilaian'
                        });
                    }
                },
                error: function() {
                    Swal.close();
                Swal.fire({
                    icon: 'error',
                        title: 'Error!',
                        text: 'Terjadi kesalahan saat menyimpan penilaian'
                });
                }
            });
        }
    </script>
</body>
</html>
